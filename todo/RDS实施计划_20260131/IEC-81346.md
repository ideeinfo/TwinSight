这份文档旨在作为 AI Coding Agent（如 Cursor, Windsurf 或自定义 LLM 代理）的 **System Prompt 补充上下文**。它解析了 IEC/ISO 81346-12 标准的核心逻辑，并结合你提供的 `MC数据20230620.csv` 建立了数据映射规则。

---

# 开发者文档：基于 IEC/ISO 81346-12 的工程编码体系解析

## 1. 标准核心概念：多重属性（Multiaspect）

IEC 81346 系列标准的核心是** RDS（Reference Designation System，引用代号系统）**。它要求从三个独立但关联的视图（Aspects）来描述一个对象：

| 视图符号 | 视图名称 (Aspect) | 含义 | 在本项目中的作用 |
| --- | --- | --- | --- |
| **`=`** | **功能 (Function)** | 该对象“做什么” (例如：抽水、调压) | 实现**工艺逻辑**的可视化 |
| **`+`** | **位置 (Location)** | 该对象“在哪里” (例如：某厂房、某楼层) | 关联 **BIM 模型**的坐标/空间 |
| **`-`** | **产品 (Product)** | 该对象“是什么” (例如：某型号的泵、电缆) | 关联**物料清单 (BOM)** 和设备台账 |

> **开发要点：** AI Agent 在解析编码时，必须识别前缀符号。例如 `==G1=A1-M1` 代表一个嵌套的多层级结构。

---

## 2. IEC 81346-12 行业特定规则（能源与建筑）

针对建筑和电力设施（-12 分册），编码通常遵循**分级树状结构**：

### 2.1 结构化层级

编码从左到右表示从“整体”到“局部”的包含关系：

* **第 1 层级 (Infrastructure):** 整个项目或场站。
* **第 2 层级 (Systems):** 具体系统（如 `B` 电力供应，`W` 供水）。
* **第 3 层级 (Sub-systems/Units):** 子系统或功能单元。
* **第 4 层级 (Components):** 具体的物理元件。

### 2.2 类别字母含义 (Letter Codes)

AI Agent 应参考以下常用分类（摘自标准文本）：

* **B:** 能量转换（电能转换）
* **E:** 能量提供（照明、供暖）
* **Q:** 控制、切换、开断回路（断路器、接触器）
* **W:** 导向、运输（管道、电缆、输送带）

---

## 3. 数据映射逻辑：CSV 到 BIM

根据 `MC数据20230620.csv` 的结构，建立以下逻辑关联：

### A. 工艺逻辑 (Process Logic)

* **逻辑来源：** 提取编码中以 `=` 开头的片段。
* **跟踪路径：** `==A1=B1` (系统) -> `==A1=B1-K1` (控制元件)。
* **AI 开发任务：** 构建递归查询函数，根据输入编码的前缀深度，检索其在上级工艺树中的父节点。

### B. 电源/控制逻辑 (Power & Control)

* **识别码：** 寻找包含 `-Q` (切换器件) 和 `-W` (电缆) 的编码。
* **逻辑链路：**
1. **电源端：** 低压柜馈线回路（如 `-Q1`）。
2. **传输端：** 电缆（如 `-W1`）。
3. **负荷端：** 电机或终端设备（如 `-M1`）。


* **AI 开发任务：** 实现“溯源”算法。给定一个设备编码，通过数据库中的 `Parent_ID` 或编码字符串匹配，自动高亮其供电路径。

### C. BIM 关联 (BIM Binding)

* **关联键：** `BIM_GUID` 或 `Mark` 字段对应 CSV 中的 `Reference_Designation`（完整引用代号）。
* **可视化规则：** 当用户在系统视图中选中一个功能编码时，前端应通过 `IfcProject` 接口调用 BIM 引擎（如 Forge/Autodesk Viewer），通过该编码定位构件。

---

## 4. 给 AI Agent 的实现指令 (Prompt Snippet)

```markdown
# 编码处理规则
1. Regex匹配: 使用正则表达式 `^([=\+-])([A-Z0-9\.]+)` 解析 RDS 编码。
2. 递归构建: 对于任意给定的编码（如 ==ABC=123-M01），系统必须能够拆解并识别其所属的 Aspect（=功能）。
3. 路径搜索: 实现一个路径搜索算法，支持通过“功能视图”跨越到“位置视图”。
   - 示例：输入=B1（供电系统），返回所有 +R1（1号房间）内属于该系统的元件。
4. 数据完整性: 若 CSV 中存在断码（不符合 81346 规范），应标记为 "Legacy Data" 并在 UI 中通过 BIM_GUID 强制关联。

```

---

## 5. 后续操作建议

根据你上传的 `IDES 数据库技术调查.pdf`：

* **数据库选择：** 鉴于工程数据具有强烈的树状和网状特征（工艺链是网状，安装位置是树状），**图数据库 (Graph Database, 如 Neo4j)** 比传统 SQL 更适合存储这类逻辑跟踪关系。
* **下一步建议：** 你是否需要我为你写一段具体的 **Python 脚本**，将 CSV 中的数据转换成适合 AI Agent 处理的 **JSON 知识图谱格式**？

---

## 6. 架构演进与最佳实践 (2026-02更新)

### 6.1 核心架构调整：System Key vs Business Key
在处理 `MC数据20230620.xlsx` 时，我们确立了以下原则以解决“数据缺失”与“对象合并”的冲突：

1.  **双键策略**：
    *   **`ref_code` (System ID)**: 数据库主键/唯一约束。必须有值。
        *   对于有编码设备：`ref_code = 原始编码`。
        *   对于无编码设备（如开关）：`ref_code = 名称_Sheet_行号` (自动生成，确保物理独立)。
    *   **`mc_code` (Model ID)**: BIM 模型关联键。允许为空。
        *   完全忠实于 Excel 中的“设备编码”列。
        *   **高亮逻辑**：Viewer 仅响应 `mc_code` 非空的对象。

2.  **脏数据防御**：
    *   若检测到 `设备编码 == 名称`，系统强制视为“无编码”，自动转入 `ref_code` 生成模式，防止 115 个开关因编码相同（即都叫“一位单控暗开关”）而被错误合并。

### 6.2 树结构解析：末尾点号法则 (修正版 2026-02-04)
*   **规则更新**：**点号 `.` 不仅仅是分隔符，更是定义容器节点的关键。**
    *   **实体节点** (`...A`)：代表具体的业务单元。
    *   **容器节点** (`...A.`)：代表挂载下级设备的逻辑容器。它是 `...A` 的子节点，同时是 `...A.B` 的父节点。
    *   **层级计算**：
        *   `===A` (Level 1)
        *   `===A.` (Level 2) —— 容器
        *   `===A.B` (Level 3) —— 实体
*   **解析器行为**：不仅要保留末尾点号，还要在构建层级时，显式生成这些容器节点，以确保树形结构的完整性和逻辑正确性。这解决了“馈线柜”与“出线”在逻辑上的父子归属问题。

### 6.3 前端交互策略：客户端递归
针对“孤立显示”需求，放弃后端查询，改用前端实时计算：
1.  **数据就绪**：树组件加载时包含完整的 `mc_code` 属性。
2.  **点击触发**：用户点击任意节点。
3.  **递归收集**：算法遍历该节点下的所有子孙，提取所有 **非空 `mc_code`**。
4.  **批量指令**：将收集到的编码列列表直接发送给 Viewer 接口。