# AI 分析 n8n 配置修复与增强指南

## 1. 目标
1.  **修复配置**: 启用 AI 分析功能以使用 `.env.local` 中定义的 n8n 服务 (192.168.2.183:5678)。
2.  **增强逻辑**: 确保 n8n 集成拥有与直接集成同等稳健的文档发现能力（文本扫描、回退机制）。
3.  **稳健的同步清理**: 确保"重建知识库"能有效清除旧的无效同步记录。
4.  **修正文件名**: 确保同步的文档在 Open WebUI 中显示其原始文件名，而不是系统路径。

## 2. 变更内容

### 后端配置（已解决）
修改 `server/config/index.js` 以强制加载 `../../.env.local` (`override: true`)。
在 `.env.local` 中启用了 `USE_N8N_WORKFLOW=true`。

### 后端逻辑增强（新增）
更新 `server/routes/ai-analysis.js` 以改进 n8n 工作流分支：
*   **文本扫描**: 自动检测分析文本中提到的文档名称，并将其添加到来源中，即使未通过索引显式引用。
*   **上下文回退**: 如果未找到来源（既未引用也未扫描到），自动将所有上下文文档包含为"相关文档"，以防止面板为空。
*   **名称链接**: 将纯文本形式的文档名称转换为交互式链接。
*   **[修复] 引用索引**: 修复了扫描/回退文档因缺乏索引而未出现在"参考文档"部分的问题。现在分配虚拟索引以确其被列出并正确链接。
*   **[增强] 引用格式支持**: 在 n8n 工作流中增加了对标准学术引用格式 `[X]` 和内部 ID 引用 `[id: X]` 的支持。这些现在被解析为可点击的链接，利用 RAG 来源和上下文文档进行稳健匹配。
*   **[增强] 设备分类**: 更新 `getContextData` 以在上下文中包含设备分类（例如 "[水箱]"）。这防止了 AI 在分析温度警报时将无关设备（如 "WT..." 开头的水箱）误分类为传感器。

### n8n 工作流更新（新增）
*   **创建**: `n8n-workflows/Temperature Alert Analysis Workflow_v2.json`。
*   **变更**: 更新了"构建 RAG Prompt"节点，在构建提示词时包含设备分类信息（例如 `[Water Tank]`），确保与后端 Direct Mode 保持一致。
*   **行动**: 用户需要导入此新的 JSON 文件以更新其 n8n 工作流。

### 知识库同步修复（新增）
1.  **稳健清理**: 更新 `server/routes/files.js` 以修复重建知识库时的删除顺序。现在会在确保清空前显式删除 `kb_documents`（通过内部 ID 和 Open WebUI UUID）。
2.  **文件名保留**: 更新 `server/services/openwebui-service.js` 和 `server/routes/files.js` 以在上传时传递原始文件名 (`file_name` 列)。这解决了文件在知识库中显示为哈希系统路径的问题。

## 3. 验证结果

### 问题解决："面板中缺少文档"
*   **根本原因**: 用户报告布局中找不到文档。截图显示获取文档时出现 `401 Unauthorized` 错误。
*   **解决方案**: 这是由于服务器配置更改（加载 `.env.local`）可能影响了认证密钥或会话有效性。
*   **行动**: 建议用户 **注销并重新登录** 以刷新令牌。

### 功能验证：n8n 分析与知识库同步
1.  **服务器重启**: 后端自动重启。
2.  **功能测试**:
    *   在 n8n 模式下触发 AI 分析。
    *   **预期**:
        *   后端调用 n8n。
        *   结果文本包含文档链接。
        *   "来源"列表已填充（通过引用或回退）。
        *   底部正确生成"参考文档"部分。
3.  **知识库重建测试**:
    *   右键点击模型 -> "创建知识库" -> 确认重建。
    *   **预期**: 无效同步记录被清除，准备好进行新的同步。
4.  **文件名测试**:
    *   同步文档到知识库。
    *   **预期**: Open WebUI 中的文件显示原始名称（如 "manual.pdf"）而不是系统名称（如 "1766...pdf"）。

### 5. 引用格式验证
*   **范围**: 验证 n8n 工作流对 `[id: X]` 和 `[X]` 引用格式的处理。
*   **预期**: 包含这些格式的分析文本应渲染为可点击的链接（例如 `[1]` 或 `[manual.pdf]`）。如果 `[id: X]` 指向已知文档，即使不在主要来源列表中也应正确链接。

### 6. 设备上下文验证
*   **范围**: 验证 AI 是否正确识别设备类型且不产生传感器幻觉。
*   **测试**: 在包含混合设备（例如水箱 `WT...`）的房间触发分析。
*   **预期**:
    *   (Direct Mode) 控制台日志显示 Prompt 包含分类：`- WT0153 (...) [Water Tank]`。
    *   (n8n Mode) 导入 `Temperature Alert Analysis Workflow_v2.json`。触发分析。验证"构建 RAG Prompt"节点（通过 n8n 执行历史）构建的 Prompt 包含 `[Category]`。
    *   (分析结果) AI 正确区分"温度传感器"和"水箱"，避免误分类。
