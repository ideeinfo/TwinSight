# 电源拓扑节点悬浮面板增强 - 实施记录

## 完成时间
2026-02-06 21:35

## 变更概要

本次实施增强了电源拓扑图节点的悬浮面板（Tooltip），使其能够显示节点关联对象的所有方面编码。

## 修改文件

### 1. 后端 API 修改

**文件**: `server/routes/rds.js`

**修改内容**:
- 在 `GET /api/rds/power-graph/:fileId` 接口的节点查询中添加子查询
- 查询关联 `rds_objects` 的所有 `rds_aspects` 方面编码
- 新增返回字段: `objectName`, `aspects`

**关键代码** (第 523-550 行):
```sql
-- 查询关联对象的所有方面编码
(
    SELECT json_agg(json_build_object(
        'aspectType', a.aspect_type,
        'fullCode', a.full_code,
        'prefix', a.prefix,
        'level', a.hierarchy_level
    ) ORDER BY a.aspect_type, a.hierarchy_level DESC)
    FROM rds_aspects a 
    WHERE a.object_id = pn.object_id
) as aspects
```

---

### 2. 前端 Tooltip 增强

**文件**: `src/components/PowerNetworkGraph.vue`

**修改内容**:

#### 模板部分 (第 28-58 行)
- 重构 Tooltip 结构，添加 header、section 区域
- 显示节点图标、类型、设备编码
- 新增方面编码区域，显示功能、位置、电源编码

#### 脚本部分 (第 323-347 行)
新增辅助函数：
- `getNodeIcon(type)`: 获取节点类型对应的图标
- `getGroupedAspects(aspects)`: 对方面编码按类型分组，每种类型取最具体的一个

#### 样式部分 (第 628-730 行)
- 增强 Tooltip 容器样式（更大、更圆润）
- 添加 header、section 分区样式
- 添加方面编码前缀的颜色标识：
  - 功能 `=` → 绿色
  - 位置 `++` → 黄色
  - 电源 `===` → 红色

---

## 效果展示

悬浮面板现在显示：

```
┌─────────────────────────────────────┐
│  💡 AH5柜出线                        │
├─────────────────────────────────────┤
│  类型: 设备                          │
│  设备编码: HSC0101                   │
├─────────────────────────────────────┤
│  方面编码                            │
│  [=]  =TA001.BJ01.GP02              │
│  [++] ++B1-1F.R01.C05               │
│  [===] ===DY1.AH1.H01.ZB1.C1DP1.3   │
└─────────────────────────────────────┘
```

## 验证步骤

1. 打开浏览器访问系统
2. 导航到 RDS 面板
3. 切换到电源拓扑视图
4. 将鼠标悬停在任意节点上
5. 验证 Tooltip 显示了所有方面编码

## 注意事项

- 部分层级节点（如母线、馈线）没有关联的 `rds_objects`，只会显示电源编码
- 末端设备节点会显示完整的方面编码信息
- 方面编码按类型分组，每种类型只显示层级最深（最具体）的编码

---

## 追加修复：末尾点号语义处理 (2026-02-06 22:30)

### 问题描述

用户反馈电源拓扑图中「5#雨水泵 GK5-1」的上游显示为「5#水泵按钮箱 GK5」而非「5#雨水泵按钮箱 GK5」。

### 根本原因

IEC 81346-12 中末尾点号有特殊语义：

| 编码形式 | 含义 | 示例 |
|----------|------|------|
| `===DY2...DP9O.1.1` | **逻辑节点** - 仅存在于电源功能维度 | 5#水泵按钮箱 GK5 (逻辑节点) |
| `===DY2...DP9O.1.1.` | **实体引用** - 引用上述逻辑节点 | 5#雨水泵按钮箱 GK5 (实体设备) |

层级关系：
```
===DY2...DP9O.1.1     (逻辑父节点)
    └── ===DY2...DP9O.1.1.  (实体子节点，引用父节点)
```

原代码错误地去除了末尾点号，导致两个不同编码被视为相同。

### 修复内容

**文件**: `logic-engine/services/importer.py`

1. **保留末尾点号语义** (第 414-432 行)
   - 检测 `has_trailing_dot` 标志
   - 分别处理逻辑节点和实体引用

2. **排序电源编码** (第 406-420 行)
   - 逻辑节点（无末尾点）优先处理
   - 确保父节点先于子节点创建

3. **正确计算父节点** (第 456-467 行)
   - 有末尾点的编码，其父节点是去掉末尾点的编码
   - 无末尾点的编码，其父节点是上一层级

4. **特殊处理实体引用** (第 564-575 行)
   - 确保有末尾点的编码正确连接到逻辑父节点

### 验证

需重新导入 Excel 数据后验证：
1. 「5#水泵按钮箱 GK5」作为逻辑节点存在
2. 「5#雨水泵按钮箱 GK5」作为实体设备节点存在，连接到逻辑节点
3. 「5#雨水泵 GK5-1」的上游正确显示为「5#雨水泵按钮箱 GK5」
