# 环境配置

<cite>
**本文档引用的文件**  
- [docker/.env.example](file://docker/.env.example)
- [docker/.env.production.example](file://docker/.env.production.example)
- [docker/docker-compose.prod.yml](file://docker/docker-compose.prod.yml)
- [docker/nginx.conf](file://docker/nginx.conf)
- [.env](file://.env)
- [.env.production](file://.env.production)
- [server/config/index.js](file://server/config/index.js)
- [server/config/database.js](file://server/config/database.js)
- [server/config/auth.js](file://server/config/auth.js)
- [server/models/influx-config.js](file://server/models/influx-config.js)
- [server/services/n8n-service.js](file://server/services/n8n-service.js)
- [server/services/openwebui-service.js](file://server/services/openwebui-service.js)
- [server/config/openwebui-config.js](file://server/config/openwebui-config.js)
</cite>

## 目录
1. [环境配置概述](#环境配置概述)
2. [开发与生产环境变量配置](#开发与生产环境变量配置)
3. [关键配置项说明](#关键配置项说明)
4. [Docker Compose 生产环境配置](#docker-compose-生产环境配置)
5. [环境变量安全实践](#环境变量安全实践)
6. [SSL 证书配置方法](#ssl-证书配置方法)

## 环境配置概述

本项目采用多环境配置策略，通过 Docker 和环境变量实现开发、测试和生产环境的隔离与灵活部署。系统核心配置通过 `.env` 文件管理，结合 `docker-compose` 实现服务编排。项目提供 `.env.example` 和 `.env.production.example` 两个模板文件，分别用于指导开发和生产环境的配置。

整个系统架构包含多个核心服务：PostgreSQL 数据库、InfluxDB 时序数据库、n8n 工作流引擎、Open WebUI AI 对话界面、Node-RED IoT 数据流处理和 Grafana 监控仪表盘。所有服务通过 Nginx 反向代理统一对外提供服务，实现端口聚合和 HTTPS 终止。

**Section sources**
- [docker/.env.example](file://docker/.env.example#L1-L47)
- [docker/.env.production.example](file://docker/.env.production.example#L1-L104)
- [docker/docker-compose.prod.yml](file://docker/docker-compose.prod.yml#L1-L262)

## 开发与生产环境变量配置

### 开发环境配置

开发环境使用 `docker/.env.example` 作为模板，创建 `.env` 文件进行配置。该文件主要包含 n8n 基础认证、Gemini API 密钥和邮件通知等配置。

配置步骤：
1. 复制 `docker/.env.example` 到 `docker/.env`
2. 根据实际需求修改配置值，特别是 `N8N_BASIC_AUTH_PASSWORD` 和 `GEMINI_API_KEY`
3. 启动服务：`docker-compose up -d`

### 生产环境配置

生产环境使用 `docker/.env.production.example` 作为模板，创建 `.env` 文件进行配置。该文件包含完整的生产环境配置，包括数据库、AI 服务、监控服务和通知配置。

配置步骤：
1. 复制 `docker/.env.production.example` 到 `docker/.env`
2. 填写必填项：`DB_PASSWORD`、`GEMINI_API_KEY`、`N8N_AUTH_PASSWORD`
3. 配置域名 `DOMAIN` 和时区 `TZ`
4. 如需使用邮件通知，填写 SMTP 配置
5. 将 SSL 证书放置在 `./ssl/` 目录下
6. 启动服务：`docker-compose -f docker-compose.prod.yml up -d`

**Section sources**
- [docker/.env.example](file://docker/.env.example#L1-L47)
- [docker/.env.production.example](file://docker/.env.production.example#L1-L104)
- [docker/docker-compose.prod.yml](file://docker/docker-compose.prod.yml#L99-L101)

## 关键配置项说明

### 数据库配置

**DATABASE_URL**：数据库连接字符串，采用 PostgreSQL URL 格式 `postgresql://user:pass@host:5432/dbname`。在生产环境中，该变量通常由云平台（如 Railway）自动注入。系统优先使用 `DATABASE_URL`，若未设置则回退到单独的数据库配置项。

**DB_HOST/DB_PORT/DB_NAME/DB_USER/DB_PASSWORD**：数据库连接参数，分别对应主机地址、端口、数据库名称、用户名和密码。这些参数在 `server/config/index.js` 中被读取并用于构建数据库连接池。

```mermaid
classDiagram
class DatabaseConfig {
+string host
+number port
+string database
+string user
+string password
+string connectionString
+object ssl
}
class Config {
+object server
+object database
+object influx
+object jwt
+object upload
+object cors
+object api
+object ai
}
Config --> DatabaseConfig : "包含"
```

**Diagram sources**
- [server/config/index.js](file://server/config/index.js#L25-L41)
- [server/config/database.js](file://server/config/database.js#L11-L20)

### JWT 配置

**JWT_SECRET**：JWT（JSON Web Token）签名密钥，用于用户认证和会话管理。在生产环境中必须设置为强随机字符串，不能使用默认值。该密钥用于生成和验证 JWT token，确保系统安全性。

**JWT_EXPIRES_IN**：访问令牌过期时间，默认为 24 小时。
**JWT_REFRESH_EXPIRES_IN**：刷新令牌过期时间，默认为 7 天。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant API as "API 服务"
participant Auth as "认证服务"
Client->>API : 发送请求 (带 JWT)
API->>Auth : 验证 JWT 签名
Auth-->>API : 验证结果
API->>Client : 返回响应或 401 错误
Note over Auth,API : 使用 JWT_SECRET 进行签名验证
```

**Diagram sources**
- [server/config/index.js](file://server/config/index.js#L52-L56)
- [server/config/auth.js](file://server/config/auth.js#L135-L141)

### InfluxDB 配置

**INFLUXDB_URL**：InfluxDB 时序数据库的访问地址。系统通过该 URL 与 InfluxDB 进行通信，用于存储和查询时间序列数据。在 `docker-compose.prod.yml` 中，服务间通过内部网络通信，使用 `http://influxdb:8086` 作为 URL。

关键配置项：
- **INFLUX_ORG**：InfluxDB 组织名称
- **INFLUX_BUCKET**：数据存储桶名称
- **INFLUX_TOKEN**：访问令牌，用于身份验证
- **INFLUX_USER/INFLUX_PASSWORD**：用户名和密码，用于基础认证

```mermaid
flowchart TD
Start([应用启动]) --> LoadConfig["加载环境变量配置"]
LoadConfig --> CheckInflux["检查 InfluxDB 配置"]
CheckInflux --> |配置有效| ConnectInflux["连接 InfluxDB"]
CheckInflux --> |配置无效| ReturnError["返回错误"]
ConnectInflux --> TestConnection["测试连接"]
TestConnection --> |连接成功| Ready["服务就绪"]
TestConnection --> |连接失败| HandleError["处理错误"]
HandleError --> Retry["重试或告警"]
Retry --> Ready
ReturnError --> End([服务启动失败])
Ready --> End
```

**Diagram sources**
- [server/config/index.js](file://server/config/index.js#L44-L49)
- [server/models/influx-config.js](file://server/models/influx-config.js#L108-L176)

### AI 服务配置

**GEMINI_API_KEY**：Google Gemini API 密钥，用于 AI 分析和 Open WebUI 服务。该密钥是系统 AI 功能的核心，必须正确配置才能使用 AI 相关功能。

**N8N_WEBHOOK_URL**：n8n 工作流的 Webhook 地址，用于触发自动化工作流。在生产环境中通常配置为 `https://your-domain.com/webhook/`。

**OPENWEBUI_API_KEY**：Open WebUI 服务的 API 密钥，用于知识库管理和 RAG（检索增强生成）功能。

```mermaid
classDiagram
class AIConfig {
+string geminiApiKey
+string n8nWebhookUrl
}
class OpenWebUIConfig {
+string baseUrl
+string apiKey
+string defaultModel
+object rag
}
class N8NConfig {
+string baseUrl
+string authUser
+string authPassword
}
AIConfig --> OpenWebUIConfig : "使用"
AIConfig --> N8NConfig : "使用"
```

**Diagram sources**
- [server/config/index.js](file://server/config/index.js#L83-L86)
- [server/services/openwebui-service.js](file://server/services/openwebui-service.js#L6-L359)
- [server/services/n8n-service.js](file://server/services/n8n-service.js#L7-L150)

## Docker Compose 生产环境配置

### 服务架构概览

`docker-compose.prod.yml` 定义了完整的生产环境服务栈，包含核心应用、AI 服务、IoT 服务和监控服务。所有服务通过名为 `tandem-network` 的自定义桥接网络进行通信。

```mermaid
graph TB
subgraph "核心服务"
Nginx[Nginx 反向代理]
API[后端 API 服务]
Postgres[PostgreSQL 数据库]
end
subgraph "AI 服务"
N8N[n8n 工作流]
OpenWebUI[Open WebUI]
end
subgraph "IoT 服务"
InfluxDB[InfluxDB 时序数据库]
NodeRED[Node-RED]
end
subgraph "监控服务"
Grafana[Grafana 仪表盘]
end
Nginx --> API
Nginx --> N8N
Nginx --> OpenWebUI
Nginx --> NodeRED
Nginx --> Grafana
API --> Postgres
API --> InfluxDB
N8N --> API
N8N --> OpenWebUI
NodeRED --> InfluxDB
NodeRED --> Postgres
Grafana --> InfluxDB
Grafana --> Postgres
```

**Diagram sources**
- [docker/docker-compose.prod.yml](file://docker/docker-compose.prod.yml#L6-L262)

### 核心服务配置

**api 服务**：后端 API 服务，基于 Node.js 构建。配置了健康检查，确保在 PostgreSQL 服务健康后才启动。通过环境变量注入数据库和 AI 服务配置。

**postgres 服务**：PostgreSQL 数据库，使用 `pgvector/pgvector:pg16` 镜像，支持向量存储功能。配置了数据卷 `postgres_data` 持久化数据，并设置了健康检查。

**nginx 服务**：Nginx 反向代理，负责 HTTPS 终止和请求路由。将外部 80 和 443 端口映射到容器内部，通过配置文件 `nginx.conf` 定义路由规则。

### AI 与自动化服务配置

**n8n 服务**：工作流自动化平台，配置了基础认证保护。通过 `N8N_BASIC_AUTH_ACTIVE` 启用认证，`N8N_BASIC_AUTH_USER` 和 `N8N_BASIC_AUTH_PASSWORD` 设置认证凭据。配置了 `N8N_PATH: /n8n/` 以支持反向代理路径。

**open-webui 服务**：AI 对话界面，通过 `ENABLE_SIGNUP: false` 禁用用户注册，仅允许管理员创建的用户访问。配置了 Gemini API 密钥，通过 OpenAI 兼容接口调用 Google Gemini 服务。

### IoT 与监控服务配置

**influxdb 服务**：时序数据库，配置了初始化模式，自动创建组织、存储桶和管理员令牌。数据通过 `influxdb_data` 和 `influxdb_config` 两个卷持久化。

**nodered 服务**：IoT 数据流处理平台，配置了与 InfluxDB 和 PostgreSQL 的依赖关系，确保在这些服务启动后再启动。

**grafana 服务**：数据可视化仪表盘，配置了管理员用户和密码，通过环境变量 `GF_SERVER_ROOT_URL` 设置根 URL。

**Section sources**
- [docker/docker-compose.prod.yml](file://docker/docker-compose.prod.yml#L6-L262)
- [docker/nginx.conf](file://docker/nginx.conf#L1-L240)

## 环境变量安全实践

### 敏感信息保护

1. **禁止提交敏感信息**：所有包含敏感信息的 `.env` 文件都应在 `.gitignore` 中排除，防止意外提交到代码仓库。

2. **使用强密码**：所有认证相关的密码（如 `DB_PASSWORD`、`N8N_AUTH_PASSWORD`）必须使用强随机字符串，长度不少于 16 位，包含大小写字母、数字和特殊字符。

3. **最小权限原则**：数据库用户应遵循最小权限原则，仅授予必要的权限。例如，应用用户不应具有 `SUPERUSER` 权限。

4. **环境变量隔离**：开发、测试和生产环境使用不同的环境变量文件，避免敏感信息泄露。

5. **定期轮换密钥**：定期轮换 API 密钥和密码，特别是在怀疑密钥可能泄露时。

### 配置管理最佳实践

1. **使用模板文件**：使用 `.env.example` 和 `.env.production.example` 作为模板，避免直接编辑生产配置文件。

2. **配置验证**：在启动服务前验证关键配置项是否已设置。在 `docker-compose.prod.yml` 中，使用 `${VAR:?错误信息}` 语法确保必填项不为空。

3. **配置文档化**：在配置文件中添加详细的注释，说明每个配置项的作用和取值范围。

4. **备份配置**：定期备份生产环境的配置文件，以便在需要时快速恢复。

**Section sources**
- [docker/.env.production.example](file://docker/.env.production.example#L85-L89)
- [docker/docker-compose.prod.yml](file://docker/docker-compose.prod.yml#L17-L18)
- [docker/docker-compose.prod.yml](file://docker/docker-compose.prod.yml#L127-L128)

## SSL 证书配置方法

### 证书文件准备

1. 将 SSL 证书文件放置在项目根目录的 `./ssl/` 目录下：
   - `fullchain.pem`：证书链文件
   - `privkey.pem`：私钥文件

2. 确保证书文件权限安全，私钥文件应设置为仅所有者可读（权限 600）。

### Nginx 配置

在 `docker/nginx.conf` 中配置 SSL 终止：

```nginx
server {
    listen 443 ssl http2;
    server_name _;

    # SSL 证书配置
    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/privkey.pem;
    
    # SSL 安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
}
```

### HTTP 重定向

配置 HTTP 到 HTTPS 的自动重定向，确保所有流量都通过加密连接：

```nginx
server {
    listen 80;
    server_name _;
    
    # Let's Encrypt 证书验证路径
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
    
    # 其他请求重定向到 HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}
```

### 安全头配置

Nginx 配置中包含多项安全头，增强系统安全性：

- `X-Frame-Options: SAMEORIGIN`：防止点击劫持攻击
- `X-Content-Type-Options: nosniff`：防止 MIME 类型嗅探
- `X-XSS-Protection: 1; mode=block`：启用 XSS 过滤

**Section sources**
- [docker/.env.production.example](file://docker/.env.production.example#L93-L97)
- [docker/nginx.conf](file://docker/nginx.conf#L99-L114)
- [docker/nginx.conf](file://docker/nginx.conf#L78-L91)