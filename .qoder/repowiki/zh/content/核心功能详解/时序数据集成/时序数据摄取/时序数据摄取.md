# 时序数据摄取

<cite>
**本文档引用的文件**
- [room_temperatures.csv](file://public/data/room_temperatures.csv)
- [influx.ts](file://src/services/influx.ts)
- [timeseries.js](file://server/routes/timeseries.js)
- [generate_csv.js](file://scripts/generate_csv.js)
</cite>

## 目录
1. [CSV文件结构与内容](#csv文件结构与内容)
2. [数据写入流程](#数据写入流程)
3. [数据模型与流](#数据模型与流)
4. [数据摄取配置](#数据摄取配置)

## CSV文件结构与内容

`room_temperatures.csv`文件是系统中的时序数据源，包含了多个房间的温度历史数据。该文件位于`public/data/`目录下，其结构为标准的CSV格式，第一行为表头，定义了时间戳和各个房间的温度字段。

文件的第一列是`timestamp`，表示数据采集的时间点，采用ISO 8601格式（例如：`2025-11-02T07:19:18.962Z`）。后续的列以`Room_0`到`Room_49`命名，代表50个不同房间的温度读数，每个值都是一个浮点数，单位为摄氏度。这种结构化的数据格式便于批量处理和分析。

该CSV文件由`scripts/generate_csv.js`脚本生成，该脚本模拟了30天内每小时的温度数据，为系统提供了用于测试和演示的时序数据集。数据生成时考虑了日常温度变化模式（清晨最冷，下午最热）以及特殊房间（如泵房、配电室）的额外温度偏移。

**Section sources**
- [room_temperatures.csv](file://public/data/room_temperatures.csv)
- [generate_csv.js](file://scripts/generate_csv.js)

## 数据写入流程

`writeRoomHistory`函数是将CSV中的温度数据解析并写入InfluxDB时序数据库的核心功能。该函数定义在`src/services/influx.ts`文件中，其工作流程如下：

1.  **数据准备**：函数接收一个`roomCode`（房间编码）和一个`points`数组作为参数。`points`数组中的每个元素都是一个包含`timestamp`（时间戳，毫秒）和`value`（温度值）的对象。
2.  **转义处理**：在构造写入InfluxDB的数据行之前，会调用`escTag`函数对`roomCode`进行转义。该函数将字符串中的逗号（`,`）、等号（`=`）和空格（` `）替换为下划线（`_`），以确保这些特殊字符不会破坏InfluxDB Line Protocol的语法。
3.  **构建数据行**：使用JavaScript的`map`方法，将`points`数组中的每个数据点转换为符合InfluxDB Line Protocol格式的字符串。格式为：`measurement,tag=value field=value timestamp`。具体到本例，其格式为`room_temp,room={转义后的roomCode} value={value} {timestamp}`。
4.  **构造HTTP请求**：将所有转换后的数据行用换行符连接成一个字符串，作为HTTP POST请求的`body`。请求的目标URL由环境变量`VITE_INFLUX_URL`、`VITE_INFLUX_ORG`和`VITE_INFLUX_BUCKET`拼接而成，并指定了时间精度为毫秒（`precision=ms`）。
5.  **发送请求**：使用`fetch` API发送POST请求。请求头`Authorization`根据配置使用`Token`或`Basic`认证方式。如果写入成功，函数返回`{ ok: true }`；如果InfluxDB未配置，则返回`{ ok: false, reason: 'not_configured' }`。

```mermaid
flowchart TD
A[调用 writeRoomHistory] --> B{InfluxDB 已配置?}
B --> |否| C[返回 {ok: false}]
B --> |是| D{有数据点?}
D --> |否| E[返回 {ok: true}]
D --> |是| F[遍历 points 数组]
F --> G[调用 escTag 转义 roomCode]
G --> H[构建 Line Protocol 字符串]
H --> I[连接所有数据行]
I --> J[构造 HTTP POST 请求]
J --> K[发送到 InfluxDB]
K --> L{响应成功?}
L --> |是| M[返回 {ok: true}]
L --> |否| N[返回 {ok: false}]
```

**Diagram sources**
- [influx.ts](file://src/services/influx.ts#L26-L36)

**Section sources**
- [influx.ts](file://src/services/influx.ts#L26-L36)

## 数据模型与流

在InfluxDB中，数据模型由`Point`类型定义，该类型在`src/services/influx.ts`文件中声明为一个包含`timestamp`（数字类型，表示毫秒时间戳）和`value`（数字类型，表示温度值）的接口。这个简单的数据结构是时序数据流的基础。

数据流从CSV文件开始，经过解析后，通过`writeRoomHistory`函数被批量写入InfluxDB。在InfluxDB内部，数据被组织为：
- **Measurement**：测量名称，此处为`room_temp`。
- **Tags**：标签，用于索引和快速查询，此处包含`room`和`code`，其值为转义后的`roomCode`。
- **Fields**：字段，存储实际的数值数据，此处为`value`。
- **Timestamp**：数据点的时间戳。

这种模型设计使得可以高效地按房间（`room`或`code`标签）查询和聚合数据。例如，可以轻松查询某个房间在特定时间段内的平均温度。

**Section sources**
- [influx.ts](file://src/services/influx.ts#L24)

## 数据摄取配置

要成功将数据写入InfluxDB，必须正确配置相关的环境变量。这些配置分为前端和后端两部分：

1.  **前端配置**（用于数据读取和可视化）：
    - `VITE_INFLUX_URL`: InfluxDB服务器的URL（例如：`http://localhost:8086`）。
    - `VITE_INFLUX_TOKEN`: 用于认证的InfluxDB API Token。
    - `VITE_INFLUX_ORG`: InfluxDB组织名称。
    - `VITE_INFLUX_BUCKET`: InfluxDB存储桶名称。
    - `VITE_INFLUX_BASIC`: 是否使用基本认证（`true`/`false`）。
    - `VITE_INFLUX_USER` 和 `VITE_INFLUX_PASSWORD`: 如果使用基本认证，则需要提供用户名和密码。

    这些变量通常在`.env`或`.env.local`文件中定义，并通过Vite的`import.meta.env`在前端代码中访问。

2.  **后端配置**（用于外部数据接入）：
    - `INFLUX_URL`, `INFLUX_ORG`, `INFLUX_BUCKET`, `INFLUX_TOKEN`: 与前端配置对应的InfluxDB连接信息，由后端服务`server/routes/timeseries.js`使用。
    - `API_KEY_SECRET`: 用于生成安全API Key的密钥，确保外部系统只能向其被授权的空间写入数据。

这些配置确保了系统能够安全、可靠地与InfluxDB进行通信，无论是从外部系统接收数据还是在前端应用中查询数据。

**Section sources**
- [influx.ts](file://src/services/influx.ts#L1-L7)
- [timeseries.js](file://server/routes/timeseries.js#L11-L17)