# 时间轴位置同步

<cite>
**本文档引用的文件**   
- [MainView.vue](file://src/components/MainView.vue)
- [backup.vue](file://src/components/backup.vue)
</cite>

## 目录
1. [时间轴位置与模型状态同步机制](#时间轴位置与模型状态同步机制)
2. [progress变量驱动状态更新](#progress变量驱动状态更新)
3. [时间轴拖拽与平移操作](#时间轴拖拽与平移操作)
4. [时间刻度标签生成](#时间刻度标签生成)
5. [scrubber元素视觉同步](#scrubber元素视觉同步)
6. [代码示例](#代码示例)

## 时间轴位置与模型状态同步机制

该系统通过`progress`变量作为核心驱动，实现时间轴位置与模型状态的同步。`progress`变量表示当前时间在时间范围内的百分比位置，其值变化会触发一系列联动更新，包括模型状态、温度标签、图表数据等。整个同步机制基于响应式编程实现，当`progress`值改变时，相关的计算属性和监听器会自动更新，确保系统各部分状态的一致性。

**Section sources**
- [MainView.vue](file://src/components/MainView.vue#L218)
- [backup.vue](file://src/components/backup.vue#L138)

## progress变量驱动状态更新

`progress`变量是整个系统状态更新的核心驱动力。它是一个响应式变量，其值范围为0-100，表示当前时间在时间范围内的百分比位置。当`progress`值发生变化时，会触发多个计算属性和监听器的更新，从而驱动整个系统的状态变化。

`progress`变量主要通过以下方式驱动状态更新：
1. 触发`currentTemp`计算属性更新，获取当前时间点的温度值
2. 触发`setTagTempsAtCurrentTime`方法，更新所有房间标签的温度显示
3. 触发`isLive`计算属性更新，判断是否处于实时模式
4. 触发`currentDisplayDate`计算属性更新，获取当前显示的日期时间

**Section sources**
- [MainView.vue](file://src/components/MainView.vue#L218)
- [backup.vue](file://src/components/backup.vue#L138)

## 时间轴拖拽与平移操作

时间轴的拖拽和左右平移操作通过`startDrag`、`stopDrag`和`panTimeline`方法实现。这些方法共同协作，提供流畅的用户交互体验。

`startDrag`方法在用户按下时间轴轨道时触发，它会：
1. 设置`isDragging`标志为true，表示开始拖拽
2. 停止播放动画
3. 更新`progress`值
4. 绑定鼠标移动和释放事件监听器

`stopDrag`方法在用户释放鼠标时触发，它会：
1. 设置`isDragging`标志为false，表示结束拖拽
2. 移除鼠标移动和释放事件监听器

`panTimeline`方法在用户点击左右箭头按钮时触发，它会：
1. 根据参数d的正负值决定平移方向
2. 计算时间偏移量
3. 更新`startDate`和`endDate`的值，实现时间范围的平移

**Section sources**
- [MainView.vue](file://src/components/MainView.vue#L2457-L2463)
- [backup.vue](file://src/components/backup.vue#L424-L433)

## 时间刻度标签生成

`generatedTicks`计算属性负责根据时间范围动态生成时间刻度标签。它会根据当前的时间范围自动调整刻度的密度和格式，确保在不同时间尺度下都能提供清晰可读的时间信息。

`generatedTicks`的生成逻辑如下：
1. 根据开始时间和结束时间计算时间范围
2. 根据时间范围的大小选择合适的时间间隔（小时、天、周、月等）
3. 从开始时间开始，按选定的时间间隔生成时间点
4. 为每个时间点计算在时间轴上的百分比位置
5. 根据时间点生成相应的标签文本
6. 返回包含位置、类型、标签文本等信息的刻度数组

**Section sources**
- [MainView.vue](file://src/components/MainView.vue#L520-L527)
- [backup.vue](file://src/components/backup.vue#L216-L222)

## scrubber元素视觉同步

`scrubber`元素的CSS定位与`progress`值绑定，实现视觉上的位置同步。`scrubber`是一个指示器，显示当前时间在时间轴上的位置。

`scrubber`的视觉同步通过以下方式实现：
1. 在模板中使用`:style`绑定`left`属性
2. 将`progress`值直接作为`left`属性的值
3. 使用CSS的`transform: translateX(-50%)`确保`scrubber`的中心对齐
4. 添加CSS过渡效果，使位置变化更加平滑

**Section sources**
- [MainView.vue](file://src/components/MainView.vue#L87)
- [backup.vue](file://src/components/backup.vue#L70)

## 代码示例

以下是时间轴交互与数据更新同步的关键代码示例：

```vue
<template>
  <div class="track-container" ref="trackRef" @mousedown="startDrag">
    <div class="ticks-layer">
      <div v-for="(tick, index) in generatedTicks" :key="index" class="tick" :class="[tick.type, { 'text-white': tick.highlight }]" :style="{ left: tick.percent + '%' }">
        <span v-if="tick.label">{{ tick.label }}</span>
      </div>
    </div>
    <div class="scrubber" :style="{ left: progress + '%' }">
      <div class="head"></div>
      <div class="line"></div>
    </div>
  </div>
</template>
```

```javascript
const startDrag = (e) => {
  isDragging.value = true;
  isPlaying.value = false;
  updateP(e);
  window.addEventListener('mousemove', onDrag);
  window.addEventListener('mouseup', stopDrag);
};

const onDrag = (e) => isDragging.value && updateP(e);

const stopDrag = () => {
  isDragging.value = false;
  window.removeEventListener('mousemove', onDrag);
  window.removeEventListener('mouseup', stopDrag);
};

const updateP = (e) => {
  if (!trackRef.value) return;
  const r = trackRef.value.getBoundingClientRect();
  progress.value = Math.max(0, Math.min(100, ((e.clientX - r.left) / r.width) * 100));
};

const panTimeline = (d) => {
  const s = startDate.value.getTime();
  const e = endDate.value.getTime();
  const off = d * ((e - s) / 3);
  startDate.value = new Date(s + off);
  endDate.value = new Date(e + off);
};
```

**Section sources**
- [MainView.vue](file://src/components/MainView.vue#L59-L89)
- [backup.vue](file://src/components/backup.vue#L60-L73)