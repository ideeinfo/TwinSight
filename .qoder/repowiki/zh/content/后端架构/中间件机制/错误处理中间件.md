# 错误处理中间件

<cite>
**本文档引用的文件**   
- [error-handler.js](file://server/middleware/error-handler.js)
- [index.js](file://server/index.js)
- [api.js](file://server/routes/api.js)
- [assets.js](file://server/routes/v1/assets.js)
- [validate.js](file://server/middleware/validate.js)
- [auth.js](file://server/middleware/auth.js)
- [asset.js](file://server/models/asset.js)
- [model-file.js](file://server/models/model-file.js)
- [files.js](file://server/routes/files.js)
- [config/index.js](file://server/config/index.js)
</cite>

## 目录
1. [简介](#简介)
2. [核心组件](#核心组件)
3. [错误处理流程](#错误处理流程)
4. [错误类型分类处理](#错误类型分类处理)
5. [实际错误场景分析](#实际错误场景分析)
6. [自定义错误类扩展](#自定义错误类扩展)
7. [日志集成建议](#日志集成建议)
8. [结论](#结论)

## 简介
本文档系统化描述了 `error-handler.js` 文件中的全局异常捕获机制。该中间件作为 Express 错误处理链的末端，负责统一处理应用程序中的所有错误，并以标准化的格式返回响应。文档详细解释了中间件如何接收 `err`、`req`、`res`、`next` 参数，并对不同类型的错误进行差异化处理。

## 核心组件

`error-handler.js` 文件定义了全局错误处理的核心组件，包括自定义的 `ApiError` 类和两个主要的中间件函数：`notFoundHandler` 和 `errorHandler`。这些组件共同构成了应用程序的统一错误处理机制。

**Section sources**
- [error-handler.js](file://server/middleware/error-handler.js#L1-L115)

## 错误处理流程

```mermaid
flowchart TD
Start([错误发生]) --> ErrorHandler["全局错误处理中间件\nerrorHandler(err, req, res, next)"]
ErrorHandler --> CheckApiError{"err instanceof ApiError?"}
CheckApiError --> |是| HandleApiError["返回标准化API错误响应"]
CheckApiError --> |否| CheckDbUnique{"err.code === '23505'?"}
CheckDbUnique --> |是| HandleDbUnique["返回409冲突错误"]
CheckDbUnique --> |否| CheckDbForeignKey{"err.code === '23503'?"}
CheckDbForeignKey --> |是| HandleDbForeignKey["返回400外键错误"]
CheckDbForeignKey --> |否| CheckJsonParse{"JSON解析错误?"}
CheckJsonParse --> |是| HandleJsonParse["返回400 JSON格式错误"]
CheckJsonParse --> |否| CheckEnv{"开发环境?"}
CheckEnv --> |是| ReturnDevError["返回500包含堆栈信息"]
CheckEnv --> |否| ReturnProdError["返回500通用错误"]
```

**Diagram sources **
- [error-handler.js](file://server/middleware/error-handler.js#L55-L108)

**Section sources**
- [error-handler.js](file://server/middleware/error-handler.js#L55-L108)
- [index.js](file://server/index.js#L27-L28)

## 错误类型分类处理

### 已知 API 错误
当错误是 `ApiError` 实例时，中间件会直接使用其 `statusCode` 和 `message` 属性来构建响应体。

```mermaid
classDiagram
class ApiError {
+statusCode : number
+message : string
+details : any
+name : string
+constructor(statusCode, message, details)
+static badRequest(message, details)
+static unauthorized(message)
+static forbidden(message)
+static notFound(message)
+static conflict(message)
+static internal(message)
}
```

**Diagram sources **
- [error-handler.js](file://server/middleware/error-handler.js#L9-L40)

### 数据库约束错误
中间件能够识别 PostgreSQL 的特定错误代码，如唯一约束冲突（23505）和外键约束失败（23503），并返回相应的用户友好错误信息。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Route as "路由处理器"
participant DB as "数据库"
participant ErrorHandler as "错误处理中间件"
Client->>Route : POST /api/assets
Route->>DB : INSERT INTO assets
DB-->>Route : 错误 : 23505 (唯一约束)
Route->>ErrorHandler : next(error)
ErrorHandler->>ErrorHandler : 检查 err.code === '23505'
ErrorHandler->>Client : 409 { success : false, error : "数据已存在" }
```

**Diagram sources **
- [error-handler.js](file://server/middleware/error-handler.js#L68-L75)
- [asset.js](file://server/models/asset.js#L32-L61)

### JSON 解析错误
当请求体的 JSON 格式不正确时，Express 会抛出 `SyntaxError`，中间件会捕获并返回标准化的错误响应。

**Section sources**
- [error-handler.js](file://server/middleware/error-handler.js#L86-L92)

### 环境相关错误
在开发环境中，中间件会返回详细的错误信息和堆栈跟踪，而在生产环境中则会隐藏敏感信息，只返回通用的“服务器内部错误”消息。

**Section sources**
- [error-handler.js](file://server/middleware/error-handler.js#L94-L107)
- [config/index.js](file://server/config/index.js#L20)

## 实际错误场景分析

### 数据库约束冲突
当尝试插入具有重复主键或唯一字段的记录时，PostgreSQL 会抛出 `23505` 错误代码。例如，在 `assets.js` 路由中创建资产时，如果资产编码已存在，数据库会拒绝插入。

**Section sources**
- [error-handler.js](file://server/middleware/error-handler.js#L68-L75)
- [asset.js](file://server/routes/v1/assets.js#L110-L111)

### 文件上传失败
在 `files.js` 路由中，文件上传可能因多种原因失败，如文件类型不被允许或文件大小超出限制。这些错误会被捕获并传递给全局错误处理中间件。

```mermaid
flowchart TD
Start([用户上传文件]) --> CheckFileType{"文件类型是ZIP?"}
CheckFileType --> |否| ThrowError["抛出 '只允许上传 SVF ZIP 文件' 错误"]
ThrowError --> ErrorHandler["全局错误处理中间件"]
ErrorHandler --> ReturnError["返回 400 错误响应"]
CheckFileType --> |是| CheckFileSize{"文件大小 < 500MB?"}
CheckFileSize --> |否| ThrowError
CheckFileSize --> |是| SaveFile["保存文件到临时目录"]
```

**Diagram sources **
- [files.js](file://server/routes/files.js#L138-L152)
- [error-handler.js](file://server/middleware/error-handler.js#L55-L108)

## 自定义错误类扩展

`ApiError` 类提供了静态工厂方法，可以方便地创建不同类型的错误实例。开发者可以通过继承 `ApiError` 类或创建新的静态方法来扩展错误类型。

```mermaid
classDiagram
class ApiError {
+statusCode : number
+message : string
+details : any
+name : string
+constructor(statusCode, message, details)
}
class ValidationError {
+fields : Array
}
class AuthenticationError {
+token : string
}
class DatabaseError {
+query : string
+params : Array
}
ApiError <|-- ValidationError
ApiError <|-- AuthenticationError
ApiError <|-- DatabaseError
```

**Diagram sources **
- [error-handler.js](file://server/middleware/error-handler.js#L9-L40)

**Section sources**
- [error-handler.js](file://server/middleware/error-handler.js#L9-L40)
- [assets.js](file://server/routes/v1/assets.js#L8)

## 日志集成建议

当前的错误处理中间件已经集成了基本的日志功能，使用 `console.error` 打印错误信息。为了更完善的日志管理，建议集成专业的日志库如 `winston` 或 `pino`，并配置日志级别、格式化和输出目标。

**Section sources**
- [error-handler.js](file://server/middleware/error-handler.js#L57)

## 结论
`error-handler.js` 提供了一个健壮且可扩展的全局错误处理机制。它通过统一的响应格式、对特定错误类型的差异化处理以及环境感知的错误信息展示，极大地提升了应用程序的稳定性和用户体验。通过自定义错误类和适当的日志集成，可以进一步增强系统的可观测性和维护性。