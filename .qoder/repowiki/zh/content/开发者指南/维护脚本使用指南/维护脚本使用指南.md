# ç»´æŠ¤è„šæœ¬ä½¿ç”¨æŒ‡å—

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**
- [init-db.js](file://server/scripts/init-db.js)
- [check-tables.js](file://server/check-tables.js)
- [check-schema.js](file://server/scripts/check-schema.js)
- [check-auth-tables.js](file://server/scripts/check-auth-tables.js)
- [fix-constraints.js](file://server/scripts/fix-constraints.js)
- [fix-file-constraints.js](file://server/scripts/fix-file-constraints.js)
- [fix-cascade.js](file://server/scripts/fix-cascade.js)
- [migrate-influx-tags.js](file://server/scripts/migrate-influx-tags.js)
- [verify-constraints.js](file://server/scripts/verify-constraints.js)
- [verify-uuid.js](file://server/scripts/verify-uuid.js)
- [test-db-connection.js](file://server/scripts/test-db-connection.js)
- [post-deploy.js](file://server/scripts/post-deploy.js)
- [schema.sql](file://server/db/schema.sql)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [åˆå§‹åŒ–è„šæœ¬](#åˆå§‹åŒ–è„šæœ¬)
3. [æ•°æ®æ ¡éªŒè„šæœ¬](#æ•°æ®æ ¡éªŒè„šæœ¬)
4. [æ•°æ®ä¿®å¤è„šæœ¬](#æ•°æ®ä¿®å¤è„šæœ¬)
5. [æ•°æ®è¿ç§»è„šæœ¬](#æ•°æ®è¿ç§»è„šæœ¬)
6. [ç”Ÿäº§ç¯å¢ƒæ•°æ®ä¿®å¤æµç¨‹](#ç”Ÿäº§ç¯å¢ƒæ•°æ®ä¿®å¤æµç¨‹)
7. [é™„å½•ï¼šè„šæœ¬æ‰§è¡Œä¾èµ–å…³ç³»å›¾](#é™„å½•è„šæœ¬æ‰§è¡Œä¾èµ–å…³ç³»å›¾)

## ç®€ä»‹
æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ `server/scripts/` ç›®å½•ä¸‹å„ç±»ç»´æŠ¤è„šæœ¬çš„åŠŸèƒ½ä¸ä½¿ç”¨æ–¹å¼ã€‚è¿™äº›è„šæœ¬ä¸»è¦ç”¨äºæ•°æ®åº“åˆå§‹åŒ–ã€æ•°æ®æ ¡éªŒã€çº¦æŸä¿®å¤å’Œæ—¶åºæ•°æ®è¿ç§»ç­‰å…³é”®è¿ç»´ä»»åŠ¡ã€‚æ–‡æ¡£å°†è„šæœ¬åˆ†ä¸ºå››ç±»è¿›è¡Œä»‹ç»ï¼šåˆå§‹åŒ–è„šæœ¬ã€æ•°æ®æ ¡éªŒè„šæœ¬ã€æ•°æ®ä¿®å¤è„šæœ¬å’Œæ•°æ®è¿ç§»è„šæœ¬ï¼Œå¹¶æä¾›æ¯ä¸ªè„šæœ¬çš„æ‰§è¡Œå‘½ä»¤ã€å‚æ•°è¯´æ˜ã€é¢„æœŸè¾“å‡ºåŠé”™è¯¯å¤„ç†ã€‚æœ€åç»“åˆå®é™…åœºæ™¯ï¼Œè¯´æ˜ç”Ÿäº§ç¯å¢ƒä¸­çš„è„šæœ¬æ‰§è¡Œé¡ºåºä¸ä¾èµ–å…³ç³»ã€‚

**æœ¬èŠ‚ä¸æ¶‰åŠå…·ä½“æºç åˆ†æï¼Œå› æ­¤æ— å¼•ç”¨æ–‡ä»¶**

## åˆå§‹åŒ–è„šæœ¬
åˆå§‹åŒ–è„šæœ¬ç”¨äºç³»ç»Ÿé¦–æ¬¡éƒ¨ç½²æ—¶åˆ›å»ºæ•°æ®åº“ç»“æ„å’ŒåŸºç¡€æ•°æ®ã€‚

### init-db.js
è¯¥è„šæœ¬ç”¨äºé¦–æ¬¡éƒ¨ç½²æ—¶åˆ›å»ºæ•°æ®åº“è¡¨ç»“æ„ã€‚

**åŠŸèƒ½è¯´æ˜**
- è¯»å– `server/db/schema.sql` æ–‡ä»¶
- æ‰§è¡Œ SQL åˆ›å»ºæ‰€æœ‰åŸºç¡€è¡¨
- è¾“å‡ºåˆ›å»ºæˆåŠŸçš„è¡¨ååˆ—è¡¨

**æ‰§è¡Œå‘½ä»¤**
```bash
node server/scripts/init-db.js
```

**é¢„æœŸè¾“å‡º**
```
ğŸš€ å¼€å§‹åˆå§‹åŒ–æ•°æ®åº“...
âœ… æ•°æ®åº“è¡¨ç»“æ„åˆ›å»ºæˆåŠŸï¼
ğŸ“‹ å·²åˆ›å»ºçš„è¡¨:
   - classifications (åˆ†ç±»ç¼–ç è¡¨)
   - asset_specs (èµ„äº§è§„æ ¼è¡¨)
   - assets (èµ„äº§è¡¨)
   - spaces (ç©ºé—´è¡¨)
```

**é”™è¯¯å¤„ç†**
- è‹¥æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè¾“å‡ºé”™è¯¯ä¿¡æ¯å¹¶é€€å‡ºè¿›ç¨‹
- è‹¥ SQL æ‰§è¡Œå‡ºé”™ï¼Œæ•è·å¼‚å¸¸å¹¶æ˜¾ç¤ºå…·ä½“é”™è¯¯æ¶ˆæ¯

**ç›¸å…³è„šæœ¬ï¼špost-deploy.js**
`post-deploy.js` æ˜¯ä¸€ä¸ªæ›´å®Œæ•´çš„éƒ¨ç½²ååˆå§‹åŒ–è„šæœ¬ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š
- æ”¯æŒç¯å¢ƒå˜é‡é…ç½®ï¼ˆåŒ…æ‹¬äº‘æœåŠ¡å¦‚ Railwayï¼‰
- å…·å¤‡æ•°æ®åº“è¿æ¥é‡è¯•æœºåˆ¶
- å¹‚ç­‰æ‰§è¡Œï¼Œå¯é‡å¤è¿è¡Œä¸ä¼šæŠ¥é”™
- è‡ªåŠ¨åˆ›å»ºç³»ç»ŸåŸºç¡€æ•°æ®

**æ‰§è¡Œå‘½ä»¤**
```bash
node server/scripts/post-deploy.js
```

**Section sources**
- [init-db.js](file://server/scripts/init-db.js#L1-L40)
- [post-deploy.js](file://server/scripts/post-deploy.js#L1-L182)

## æ•°æ®æ ¡éªŒè„šæœ¬
æ•°æ®æ ¡éªŒè„šæœ¬ç”¨äºæ£€æŸ¥æ•°æ®åº“è¡¨ç»“æ„ã€çº¦æŸå’Œæ•°æ®å®Œæ•´æ€§ã€‚

### check-tables.js
è¯¥è„šæœ¬æ£€æŸ¥æ•°æ®åº“ä¸­æ ¸å¿ƒè¡¨çš„å­˜åœ¨æ€§å’ŒåŸºæœ¬çŠ¶æ€ã€‚

**åŠŸèƒ½è¯´æ˜**
- æ£€æŸ¥ `classifications`ã€`asset_specs`ã€`assets`ã€`spaces` ç­‰æ ¸å¿ƒè¡¨æ˜¯å¦å­˜åœ¨
- éªŒè¯è¡¨çš„åŸºæœ¬ç»“æ„å®Œæ•´æ€§

**æ‰§è¡Œå‘½ä»¤**
```bash
node server/check-tables.js
```

**é¢„æœŸè¾“å‡º**
```
âœ… æ‰€æœ‰æ ¸å¿ƒè¡¨å­˜åœ¨
- classifications
- asset_specs
- assets
- spaces
```

**Section sources**
- [check-tables.js](file://server/check-tables.js)

### check-schema.js
è¯¥è„šæœ¬è¯¦ç»†æ£€æŸ¥ `asset_specs` è¡¨çš„ç»“æ„ã€‚

**åŠŸèƒ½è¯´æ˜**
- æŸ¥è¯¢è¡¨çš„æ‰€æœ‰åˆ—ä¿¡æ¯ï¼ˆåˆ—åã€æ•°æ®ç±»å‹ã€é•¿åº¦ã€æ˜¯å¦å¯ç©ºï¼‰
- æ£€æŸ¥è¡¨çš„çº¦æŸå®šä¹‰
- åˆ—å‡ºæ‰€æœ‰ç´¢å¼•ä¿¡æ¯

**æ‰§è¡Œå‘½ä»¤**
```bash
node server/scripts/check-schema.js
```

**é¢„æœŸè¾“å‡º**
```
âœ… asset_specs è¡¨çš„åˆ—ç»“æ„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ column_name            â”‚ data_type  â”‚ character_maximum_length  â”‚ is_nullable â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id                     â”‚ integer    â”‚ null                      â”‚ NO         â”‚
â”‚ spec_code              â”‚ character  â”‚ 50                        â”‚ NO         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… asset_specs è¡¨çš„çº¦æŸ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ constraint_name        â”‚ constraint_type â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ asset_specs_pkey       â”‚ PRIMARY KEY     â”‚
â”‚ asset_specs_spec_code_key â”‚ UNIQUE        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Section sources**
- [check-schema.js](file://server/scripts/check-schema.js#L1-L54)

### check-auth-tables.js
è¯¥è„šæœ¬ä¸“é—¨æ£€æŸ¥è®¤è¯ç›¸å…³è¡¨çš„çŠ¶æ€ã€‚

**åŠŸèƒ½è¯´æ˜**
- æ£€æŸ¥è®¤è¯ç³»ç»Ÿè¡¨ï¼ˆ`users`ã€`user_roles`ã€`user_identities`ã€`refresh_tokens`ï¼‰æ˜¯å¦å­˜åœ¨
- éªŒè¯é»˜è®¤ç®¡ç†å‘˜è´¦æˆ·æ˜¯å¦å­˜åœ¨
- ç»Ÿè®¡ç”¨æˆ·æ€»æ•°

**æ‰§è¡Œå‘½ä»¤**
```bash
node server/scripts/check-auth-tables.js
```

**é¢„æœŸè¾“å‡º**
```
âœ… å·²åˆ›å»ºçš„è®¤è¯è¡¨:
   - user_identities
   - user_roles
   - users

âœ… é»˜è®¤ç®¡ç†å‘˜è´¦æˆ·: admin@tandem.local
   è§’è‰²: admin

ğŸ“Š ç”¨æˆ·æ€»æ•°: 1
```

**Section sources**
- [check-auth-tables.js](file://server/scripts/check-auth-tables.js#L1-L59)

### test-db-connection.js
è¯¥è„šæœ¬æµ‹è¯•æ•°æ®åº“è¿æ¥å¹¶æä¾›å…¨é¢çš„æ•°æ®åº“çŠ¶æ€æ£€æŸ¥ã€‚

**åŠŸèƒ½è¯´æ˜**
- æµ‹è¯•æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸
- æ˜¾ç¤ºå½“å‰æ•°æ®åº“ä¿¡æ¯
- åˆ—å‡ºæ‰€æœ‰è¡¨å
- ç»Ÿè®¡å…³é”®è¡¨çš„æ•°æ®é‡

**æ‰§è¡Œå‘½ä»¤**
```bash
node server/scripts/test-db-connection.js
```

**é¢„æœŸè¾“å‡º**
```
âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼
   å½“å‰æ—¶é—´: 2024-01-15T08:30:45.123Z
   å½“å‰æ•°æ®åº“: tandem

ğŸ“‹ æ•°æ®åº“è¡¨:
   - classifications
   - asset_specs
   - assets
   - spaces
   - users

ğŸ“Š è¡¨æ•°æ®ç»Ÿè®¡:
   åˆ†ç±»: 15
   è§„æ ¼: 42
   èµ„äº§: 231
   ç©ºé—´: 89
```

**Section sources**
- [test-db-connection.js](file://server/scripts/test-db-connection.js#L1-L68)

## æ•°æ®ä¿®å¤è„šæœ¬
æ•°æ®ä¿®å¤è„šæœ¬ç”¨äºä¿®å¤æ•°æ®åº“ä¸­çš„å¤–é”®ã€çº¦æŸå’Œæ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚

### fix-constraints.js
è¯¥è„šæœ¬ä¿®å¤æ•°æ®åº“è¡¨çš„å”¯ä¸€æ€§çº¦æŸã€‚

**åŠŸèƒ½è¯´æ˜**
- åˆ é™¤æ—§çš„ç´¢å¼•
- æ£€æŸ¥å¹¶ä¸º `asset_specs`ã€`assets`ã€`spaces` è¡¨æ·»åŠ å”¯ä¸€çº¦æŸ
- ç¡®ä¿ `spec_code`ã€`asset_code`ã€`space_code` å­—æ®µçš„å”¯ä¸€æ€§

**æ‰§è¡Œå‘½ä»¤**
```bash
node server/scripts/fix-constraints.js
```

**é¢„æœŸè¾“å‡º**
```
ğŸ”§ å¼€å§‹ä¿®å¤æ•°æ®åº“çº¦æŸ...
âœ“ å·²åˆ é™¤éƒ¨åˆ†ç´¢å¼•
âœ“ å·²åˆ›å»º asset_specs å”¯ä¸€çº¦æŸ
âœ“ å·²åˆ›å»º assets å”¯ä¸€çº¦æŸ
âœ“ å·²åˆ›å»º spaces å”¯ä¸€çº¦æŸ
âœ… æ•°æ®åº“çº¦æŸä¿®å¤å®Œæˆï¼
```

**Section sources**
- [fix-constraints.js](file://server/scripts/fix-constraints.js#L1-L57)

### fix-file-constraints.js
è¯¥è„šæœ¬ä¿®å¤ä¸ `file_id` å­—æ®µç›¸å…³çš„çº¦æŸé—®é¢˜ã€‚

**åŠŸèƒ½è¯´æ˜**
- åˆ é™¤æ—§çš„å”¯ä¸€çº¦æŸå’Œç´¢å¼•
- ç¡®ä¿ `file_id` åˆ—å­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨åˆ™æ·»åŠ 
- ä¸º `assets`ã€`spaces`ã€`asset_specs` è¡¨æ·»åŠ  `file_id` å¤–é”®çº¦æŸ
- åˆ›å»ºæ–°çš„ç»„åˆå”¯ä¸€ç´¢å¼•ï¼Œä½¿ç”¨ `COALESCE` å¤„ç† `NULL` å€¼æƒ…å†µ

**æ‰§è¡Œå‘½ä»¤**
```bash
node server/scripts/fix-file-constraints.js
```

**é¢„æœŸè¾“å‡º**
```
ğŸ”§ å¼€å§‹ä¿®å¤æ•°æ®åº“çº¦æŸ...
ğŸ“¦ åˆ é™¤æ—§çº¦æŸ...
ğŸ“¦ ç¡®ä¿ file_id åˆ—å­˜åœ¨...
  âœ“ ä¸º assets è¡¨æ·»åŠ äº† file_id åˆ—
  âœ“ ä¸º spaces è¡¨æ·»åŠ äº† file_id åˆ—
  âœ“ ä¸º asset_specs è¡¨æ·»åŠ äº† file_id åˆ—
ğŸ“¦ åˆ›å»ºæ–°çš„å”¯ä¸€çº¦æŸ...
  âœ“ åˆ›å»ºäº† assets çš„å”¯ä¸€ç´¢å¼•
  âœ“ åˆ›å»ºäº† spaces çš„å”¯ä¸€ç´¢å¼•
  âœ“ åˆ›å»ºäº† asset_specs çš„å”¯ä¸€ç´¢å¼•
âœ… æ•°æ®åº“çº¦æŸä¿®å¤å®Œæˆï¼
```

**Section sources**
- [fix-file-constraints.js](file://server/scripts/fix-file-constraints.js#L1-L97)

### fix-cascade.js
è¯¥è„šæœ¬ä¿®å¤å¤–é”®çš„çº§è”åˆ é™¤è¡Œä¸ºã€‚

**åŠŸèƒ½è¯´æ˜**
- æ¸…ç†å­¤ç«‹çš„è®°å½•ï¼ˆ`file_id` å­˜åœ¨ä½†æŒ‡å‘ä¸å­˜åœ¨çš„ `model_files` è®°å½•ï¼‰
- æŸ¥æ‰¾å¹¶åˆ é™¤ç°æœ‰çš„å¤–é”®çº¦æŸ
- é‡æ–°æ·»åŠ å¸¦æœ‰ `ON DELETE CASCADE` çš„å¤–é”®çº¦æŸ
- ç¡®ä¿åˆ é™¤ `model_files` è®°å½•æ—¶ï¼Œç›¸å…³è®°å½•èƒ½è‡ªåŠ¨çº§è”åˆ é™¤

**æ‰§è¡Œå‘½ä»¤**
```bash
node server/scripts/fix-cascade.js
```

**é¢„æœŸè¾“å‡º**
```
ğŸ Starting cascade fix...

Checking table: assets
- Cleaned 3 orphaned records from assets
- Found FK constraint: assets_file_id_fkey
- Dropped constraint: assets_file_id_fkey
+ Added constraint: assets_file_id_fkey_cascade (ON DELETE CASCADE)

Checking table: spaces
- Cleaned 1 orphaned records from spaces
- No existing FK constraint found for file_id (will create one)
+ Added constraint: spaces_file_id_fkey_cascade (ON DELETE CASCADE)

Checking table: asset_specs
- Cleaned 0 orphaned records from asset_specs
- No existing FK constraint found for file_id (will create one)
+ Added constraint: asset_specs_file_id_fkey_cascade (ON DELETE CASCADE)

âœ… All constraints updated successfully.
```

**Section sources**
- [fix-cascade.js](file://server/scripts/fix-cascade.js#L1-L82)

## æ•°æ®è¿ç§»è„šæœ¬
æ•°æ®è¿ç§»è„šæœ¬ç”¨äºå¤„ç†æ—¶åºæ•°æ®åº“ä¸­çš„æ•°æ®ç»“æ„å˜æ›´ã€‚

### migrate-influx-tags.js
è¯¥è„šæœ¬å°† InfluxDB ä¸­çš„ `room` tag æ•°æ®è¿ç§»åˆ° `code` tagã€‚

**åŠŸèƒ½è¯´æ˜**
- è¿æ¥åˆ° InfluxDB å®ä¾‹
- æŸ¥è¯¢æ‰€æœ‰å”¯ä¸€çš„ `room` tag å€¼
- å¯¹æ¯ä¸ª `room` å€¼ï¼ŒæŸ¥è¯¢å…¶æ‰€æœ‰æ—¶åºæ•°æ®
- å°†æ•°æ®é‡æ–°å†™å…¥ï¼Œä½¿ç”¨ `code` tag æ›¿ä»£ `room` tag
- åˆ é™¤æ—§çš„å¸¦æœ‰ `room` tag çš„æ•°æ®

**æ‰§è¡Œå‘½ä»¤**
```bash
node server/scripts/migrate-influx-tags.js
```

**ç¯å¢ƒå˜é‡è¦æ±‚**
- `INFLUX_URL`: InfluxDB åœ°å€
- `INFLUX_ORG`: ç»„ç»‡åç§°
- `INFLUX_BUCKET`: å­˜å‚¨æ¡¶åç§°
- `INFLUX_TOKEN`: è®¤è¯ä»¤ç‰Œï¼ˆå¿…éœ€ï¼‰

**é¢„æœŸè¾“å‡º**
```
ğŸ”„ å¼€å§‹è¿ç§» InfluxDB æ•°æ®...
   URL: http://localhost:8086
   Org: demo
   Bucket: tandem

ğŸ“‹ æŸ¥è¯¢ç°æœ‰çš„ room tag å€¼...
   æ‰¾åˆ° 12 ä¸ªå”¯ä¸€çš„ room tag å€¼
   ç¤ºä¾‹: A101, A102, A103, A201, A202...

ğŸ”„ è¿ç§»æˆ¿é—´: A101
   ğŸ“Š è¿ç§» 15840 æ¡æ•°æ®ç‚¹
   âœ… å†™å…¥è¿›åº¦: 5000/15840
   âœ… å†™å…¥è¿›åº¦: 10000/15840
   âœ… å†™å…¥è¿›åº¦: 15840/15840

...

âœ… è¿ç§»å†™å…¥å®Œæˆï¼å…±å†™å…¥ 189234 æ¡æ–°æ•°æ®ç‚¹

ğŸ—‘ï¸ æ¸…ç†æ—§æ•°æ®ï¼ˆå¸¦ room tag çš„æ•°æ®ï¼‰...
   åˆ é™¤ room="A101" çš„æ—§æ•°æ®...
   âœ… å·²åˆ é™¤
   ...

ğŸ‰ è¿ç§»å®Œæˆï¼
   - è¿ç§»äº† 12 ä¸ªæˆ¿é—´
   - å†™å…¥äº† 189234 æ¡æ–°æ•°æ®ç‚¹ï¼ˆä½¿ç”¨ code tagï¼‰
   - åˆ é™¤äº†æ—§æ•°æ®ï¼ˆä½¿ç”¨ room tagï¼‰
```

**é”™è¯¯å¤„ç†**
- è‹¥ `INFLUX_TOKEN` æœªé…ç½®ï¼Œè„šæœ¬ç«‹å³é€€å‡º
- æŸ¥è¯¢ã€å†™å…¥æˆ–åˆ é™¤æ“ä½œå¤±è´¥æ—¶ï¼Œæ•è·å¹¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
- ä½¿ç”¨åˆ†æ‰¹å¤„ç†é¿å…å†…å­˜æº¢å‡º

**Section sources**
- [migrate-influx-tags.js](file://server/scripts/migrate-influx-tags.js#L1-L240)

## ç”Ÿäº§ç¯å¢ƒæ•°æ®ä¿®å¤æµç¨‹
åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ‰§è¡Œæ•°æ®ä¿®å¤æ—¶ï¼Œåº”éµå¾ªä¸¥æ ¼çš„æµç¨‹å’Œä¾èµ–å…³ç³»ï¼Œä»¥ç¡®ä¿æ•°æ®å®‰å…¨å’Œç³»ç»Ÿç¨³å®šæ€§ã€‚

### æ‰§è¡Œé¡ºåºä¸ä¾èµ–å…³ç³»
1. **è¿æ¥æµ‹è¯•**ï¼šé¦–å…ˆè¿è¡Œ `test-db-connection.js` ç¡®è®¤æ•°æ®åº“è¿æ¥æ­£å¸¸
2. **çŠ¶æ€æ£€æŸ¥**ï¼šè¿è¡Œ `check-tables.js` å’Œ `check-schema.js` è·å–å½“å‰æ•°æ®åº“çŠ¶æ€
3. **æ‰§è¡Œä¿®å¤**ï¼šæŒ‰é¡ºåºæ‰§è¡Œä¿®å¤è„šæœ¬
4. **éªŒè¯ç»“æœ**ï¼šè¿è¡ŒéªŒè¯è„šæœ¬ç¡®è®¤ä¿®å¤æ•ˆæœ

### å®Œæ•´ä¿®å¤æµç¨‹ç¤ºä¾‹
```bash
# 1. æµ‹è¯•æ•°æ®åº“è¿æ¥
node server/scripts/test-db-connection.js

# 2. æ£€æŸ¥å½“å‰çº¦æŸçŠ¶æ€
node server/scripts/verify-constraints.js

# 3. ä¿®å¤æ–‡ä»¶çº¦æŸï¼ˆæ·»åŠ  file_id åˆ—å’Œçº¦æŸï¼‰
node server/scripts/fix-file-constraints.js

# 4. ä¿®å¤çº§è”åˆ é™¤è¡Œä¸º
node server/scripts/fix-cascade.js

# 5. ä¿®å¤å…¶ä»–çº¦æŸ
node server/scripts/fix-constraints.js

# 6. éªŒè¯ UUID å­—æ®µ
node server/scripts/verify-uuid.js

# 7. å†æ¬¡æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
node server/scripts/test-db-connection.js
```

### éªŒè¯è„šæœ¬
ç³»ç»Ÿæä¾›å¤šä¸ªéªŒè¯è„šæœ¬æ¥ç¡®è®¤ä¿®å¤ç»“æœï¼š

**verify-constraints.js**ï¼šéªŒè¯å”¯ä¸€çº¦æŸæ˜¯å¦æ­£ç¡®åˆ›å»º
```bash
node server/scripts/verify-constraints.js
```

**verify-uuid.js**ï¼šéªŒè¯ UUID å­—æ®µæ˜¯å¦å·²æ­£ç¡®æ·»åŠ å’Œå¡«å……
```bash
node server/scripts/verify-uuid.js
```

### æ³¨æ„äº‹é¡¹
- åœ¨ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œå‰ï¼ŒåŠ¡å¿…å¤‡ä»½æ•°æ®åº“
- å»ºè®®åœ¨ä½å³°æœŸæ‰§è¡Œæ•°æ®ä¿®å¤æ“ä½œ
- æ¯ä¸ªè„šæœ¬æ‰§è¡Œååº”æ£€æŸ¥è¾“å‡ºç»“æœï¼Œç¡®è®¤æ— è¯¯åå†æ‰§è¡Œä¸‹ä¸€ä¸ª
- å¯¹äº `migrate-influx-tags.js` è¿™ç±»å½±å“æ—¶åºæ•°æ®çš„è„šæœ¬ï¼Œå»ºè®®å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯

**Section sources**
- [verify-constraints.js](file://server/scripts/verify-constraints.js#L1-L53)
- [verify-uuid.js](file://server/scripts/verify-uuid.js#L1-L49)

## é™„å½•ï¼šè„šæœ¬æ‰§è¡Œä¾èµ–å…³ç³»å›¾

```mermaid
graph TD
A[åˆå§‹åŒ–] --> B[init-db.js]
A --> C[post-deploy.js]
D[æ•°æ®æ ¡éªŒ] --> E[check-tables.js]
D --> F[check-schema.js]
D --> G[check-auth-tables.js]
D --> H[test-db-connection.js]
I[æ•°æ®ä¿®å¤] --> J[fix-file-constraints.js]
J --> K[fix-cascade.js]
K --> L[fix-constraints.js]
M[æ•°æ®è¿ç§»] --> N[migrate-influx-tags.js]
O[éªŒè¯] --> P[verify-constraints.js]
O --> Q[verify-uuid.js]
classDef default fill:#f0f8ff,stroke:#333,stroke-width:1px;
class A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q default;
```

**Diagram sources**
- [init-db.js](file://server/scripts/init-db.js#L1-L40)
- [post-deploy.js](file://server/scripts/post-deploy.js#L1-L182)
- [check-tables.js](file://server/check-tables.js)
- [check-schema.js](file://server/scripts/check-schema.js#L1-L54)
- [check-auth-tables.js](file://server/scripts/check-auth-tables.js#L1-L59)
- [test-db-connection.js](file://server/scripts/test-db-connection.js#L1-L68)
- [fix-file-constraints.js](file://server/scripts/fix-file-constraints.js#L1-L97)
- [fix-cascade.js](file://server/scripts/fix-cascade.js#L1-L82)
- [fix-constraints.js](file://server/scripts/fix-constraints.js#L1-L57)
- [migrate-influx-tags.js](file://server/scripts/migrate-influx-tags.js#L1-L240)
- [verify-constraints.js](file://server/scripts/verify-constraints.js#L1-L53)
- [verify-uuid.js](file://server/scripts/verify-uuid.js#L1-L49)