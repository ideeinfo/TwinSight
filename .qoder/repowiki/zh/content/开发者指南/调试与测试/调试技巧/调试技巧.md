# è°ƒè¯•æŠ€å·§

<cite>
**æœ¬æ–‡æ¡£ä¸­å¼•ç”¨çš„æ–‡ä»¶**  
- [add_debug_logging.cjs](file://server/scripts/add_debug_logging.cjs)
- [.env](file://.env)
- [.env.development](file://.env.development)
- [.env.production](file://.env.production)
- [error-handler.js](file://server/middleware/error-handler.js)
- [document-sync-service.js](file://server/services/document-sync-service.js)
- [main.js](file://src/main.js)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [å…³é”®æœåŠ¡ä¸­æ³¨å…¥è°ƒè¯•æ—¥å¿—](#å…³é”®æœåŠ¡ä¸­æ³¨å…¥è°ƒè¯•æ—¥å¿—)
3. [é…ç½®å…¨å±€è°ƒè¯•è¾“å‡º](#é…ç½®å…¨å±€è°ƒè¯•è¾“å‡º)
4. [é”™è¯¯å¤„ç†ä¸­é—´ä»¶åˆ†æ](#é”™è¯¯å¤„ç†ä¸­é—´ä»¶åˆ†æ)
5. [å‰ç«¯è°ƒè¯•å®è·µ](#å‰ç«¯è°ƒè¯•å®è·µ)
6. [å‰åç«¯æ•°æ®æµè°ƒè¯•](#å‰åç«¯æ•°æ®æµè°ƒè¯•)
7. [ç«¯åˆ°ç«¯é—®é¢˜å®šä½](#ç«¯åˆ°ç«¯é—®é¢˜å®šä½)

## ç®€ä»‹
æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜TwinSightç³»ç»Ÿçš„è°ƒè¯•æ–¹æ³•ï¼Œæ¶µç›–åç«¯æ—¥å¿—æ³¨å…¥ã€å…¨å±€æ—¥å¿—çº§åˆ«é…ç½®ã€é”™è¯¯å¤„ç†æœºåˆ¶ã€å‰ç«¯çŠ¶æ€æ£€æŸ¥ä»¥åŠæ•°æ®æµè°ƒè¯•ç­‰å…³é”®å®è·µã€‚é€šè¿‡ç»“åˆæœåŠ¡å™¨æ—¥å¿—ä¸æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼Œå¸®åŠ©å¼€å‘è€…é«˜æ•ˆå®šä½å’Œè§£å†³ç³»ç»Ÿé—®é¢˜ã€‚

## å…³é”®æœåŠ¡ä¸­æ³¨å…¥è°ƒè¯•æ—¥å¿—
é€šè¿‡è¿è¡Œ `node server/scripts/add_debug_logging.cjs` è„šæœ¬ï¼Œå¯ä»¥åœ¨å…³é”®æœåŠ¡ä¸­è‡ªåŠ¨æ³¨å…¥è°ƒè¯•æ—¥å¿—ä»£ç ã€‚è¯¥è„šæœ¬ä¼šä¿®æ”¹ `ai-analysis.js` æ–‡ä»¶ï¼Œåœ¨ç‰¹å®šä»£ç è¡Œå‰æ’å…¥è¯¦ç»†çš„ `console.log` è¾“å‡ºï¼Œç”¨äºæŸ¥çœ‹ `ragResult.sources` çš„åŸå§‹æ•°æ®ç»“æ„ã€‚

è„šæœ¬ä¼šè¾“å‡ºä»¥ä¸‹è°ƒè¯•ä¿¡æ¯ï¼š
- `ragResult.sources` çš„ç±»å‹å’Œé•¿åº¦
- å®Œæ•´çš„ `sources` å†…å®¹ï¼ˆJSONæ ¼å¼åŒ–ï¼‰
- `sources[0]` çš„æ‰€æœ‰é”®å
- `metadata[0]` çš„ç¤ºä¾‹æ•°æ®

æ‰§è¡ŒæˆåŠŸåï¼Œæ§åˆ¶å°å°†æ˜¾ç¤º "Successfully added debug logging" æç¤ºã€‚

**Section sources**
- [add_debug_logging.cjs](file://server/scripts/add_debug_logging.cjs#L1-L39)

## é…ç½®å…¨å±€è°ƒè¯•è¾“å‡º
é€šè¿‡åœ¨ `.env` æ–‡ä»¶ä¸­è®¾ç½® `LOG_LEVEL=debug`ï¼Œå¯ä»¥å¯ç”¨ç³»ç»Ÿçš„å…¨å±€è°ƒè¯•è¾“å‡ºã€‚æ­¤é…ç½®ä¼šå½±å“æ‰€æœ‰ä½¿ç”¨æ—¥å¿—è®°å½•åŠŸèƒ½çš„æ¨¡å—ï¼Œæä¾›æ›´è¯¦ç»†çš„è¿è¡Œæ—¶ä¿¡æ¯ã€‚

é¡¹ç›®åŒ…å«å¤šä¸ªç¯å¢ƒé…ç½®æ–‡ä»¶ï¼š
- `.env`ï¼šä¸»ç¯å¢ƒé…ç½®æ–‡ä»¶
- `.env.development`ï¼šå¼€å‘ç¯å¢ƒé…ç½®
- `.env.production`ï¼šç”Ÿäº§ç¯å¢ƒé…ç½®

è¿™äº›æ–‡ä»¶ä¸­å®šä¹‰äº†APIåœ°å€å’ŒOpen WebUIå¯†é’¥ç­‰å…³é”®é…ç½®ï¼Œé€šè¿‡ä¿®æ”¹è¿™äº›æ–‡ä»¶å¯ä»¥è°ƒæ•´å‰ç«¯è¯·æ±‚çš„ç›®æ ‡æœåŠ¡å™¨å’Œè°ƒè¯•è¡Œä¸ºã€‚

**Section sources**
- [.env](file://.env#L1-L6)
- [.env.development](file://.env.development#L1-L3)
- [.env.production](file://.env.production#L1-L4)

## é”™è¯¯å¤„ç†ä¸­é—´ä»¶åˆ†æ
`error-handler.js` æ–‡ä»¶å®ç°äº†ç³»ç»Ÿçš„ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶ï¼ŒåŒ…å«é”™è¯¯æ•è·ã€æ—¥å¿—è®°å½•å’Œå“åº”æ ¼å¼åŒ–åŠŸèƒ½ã€‚

### è‡ªå®šä¹‰APIé”™è¯¯ç±»
ç³»ç»Ÿå®šä¹‰äº† `ApiError` ç±»ï¼Œç»§æ‰¿è‡ªJavaScriptçš„ `Error` ç±»ï¼ŒåŒ…å«çŠ¶æ€ç ã€æ¶ˆæ¯å’Œè¯¦ç»†ä¿¡æ¯ç­‰å±æ€§ã€‚æä¾›äº†å¤šä¸ªé™æ€æ–¹æ³•åˆ›å»ºå¸¸è§é”™è¯¯ç±»å‹ï¼š
- `badRequest`ï¼š400é”™è¯¯
- `unauthorized`ï¼š401é”™è¯¯
- `forbidden`ï¼š403é”™è¯¯
- `notFound`ï¼š404é”™è¯¯
- `conflict`ï¼š409é”™è¯¯
- `internal`ï¼š500é”™è¯¯

### å…¨å±€é”™è¯¯å¤„ç†æµç¨‹
`errorHandler` ä¸­é—´ä»¶æŒ‰ç…§ä»¥ä¸‹é¡ºåºå¤„ç†é”™è¯¯ï¼š
1. æ‰“å°é”™è¯¯åˆ°æ§åˆ¶å°
2. å¤„ç†è‡ªå®šä¹‰ `ApiError` ç±»å‹
3. å¤„ç†æ•°æ®åº“å”¯ä¸€çº¦æŸé”™è¯¯ï¼ˆcode: 23505ï¼‰
4. å¤„ç†æ•°æ®åº“å¤–é”®çº¦æŸé”™è¯¯ï¼ˆcode: 23503ï¼‰
5. å¤„ç†JSONè§£æé”™è¯¯
6. åœ¨å¼€å‘æ¨¡å¼ä¸‹è¿”å›è¯¦ç»†é”™è¯¯å †æ ˆ
7. åœ¨ç”Ÿäº§æ¨¡å¼ä¸‹éšè—é”™è¯¯è¯¦æƒ…ï¼Œè¿”å›é€šç”¨é”™è¯¯ä¿¡æ¯

```mermaid
flowchart TD
Start([å¼€å§‹]) --> PrintError["æ‰“å°é”™è¯¯åˆ°æ§åˆ¶å°"]
PrintError --> CheckApiError{"æ˜¯å¦ä¸º ApiError?"}
CheckApiError --> |æ˜¯| ReturnApiError["è¿”å› ApiError å“åº”"]
CheckApiError --> |å¦| CheckUniqueConstraint{"æ˜¯å¦ä¸ºå”¯ä¸€çº¦æŸé”™è¯¯?"}
CheckUniqueConstraint --> |æ˜¯| ReturnConflict["è¿”å›å†²çªé”™è¯¯"]
CheckUniqueConstraint --> |å¦| CheckForeignKey{"æ˜¯å¦ä¸ºå¤–é”®çº¦æŸé”™è¯¯?"}
CheckForeignKey --> |æ˜¯| ReturnBadRequest["è¿”å›è¯·æ±‚é”™è¯¯"]
CheckForeignKey --> |å¦| CheckJsonError{"æ˜¯å¦ä¸ºJSONè§£æé”™è¯¯?"}
CheckJsonError --> |æ˜¯| ReturnJsonError["è¿”å›JSONé”™è¯¯"]
CheckJsonError --> |å¦| CheckDevMode{"æ˜¯å¦ä¸ºå¼€å‘æ¨¡å¼?"}
CheckDevMode --> |æ˜¯| ReturnDetailed["è¿”å›è¯¦ç»†é”™è¯¯ä¿¡æ¯"]
CheckDevMode --> |å¦| ReturnGeneric["è¿”å›é€šç”¨é”™è¯¯ä¿¡æ¯"]
ReturnApiError --> End([ç»“æŸ])
ReturnConflict --> End
ReturnBadRequest --> End
ReturnJsonError --> End
ReturnDetailed --> End
ReturnGeneric --> End
```

**Diagram sources**
- [error-handler.js](file://server/middleware/error-handler.js#L9-L108)

**Section sources**
- [error-handler.js](file://server/middleware/error-handler.js#L1-L115)

## å‰ç«¯è°ƒè¯•å®è·µ
å‰ç«¯è°ƒè¯•ä¸»è¦é€šè¿‡Vue Devtoolsè¿›è¡Œï¼Œå¯ä»¥æ£€æŸ¥ç»„ä»¶çŠ¶æ€ã€äº‹ä»¶æµå’ŒPinia storeçš„å˜åŒ–ã€‚

### PiniaçŠ¶æ€ç®¡ç†
ç³»ç»Ÿä½¿ç”¨Piniaä½œä¸ºçŠ¶æ€ç®¡ç†åº“ï¼Œåœ¨ `main.js` ä¸­åˆ›å»ºPiniaå®ä¾‹å¹¶æ³¨å†Œåˆ°Vueåº”ç”¨ã€‚å…³é”®çŠ¶æ€å­˜å‚¨åŒ…æ‹¬ï¼š
- `authStore`ï¼šè®¤è¯çŠ¶æ€
- `themeStore`ï¼šä¸»é¢˜çŠ¶æ€

åº”ç”¨å¯åŠ¨æ—¶ä¼šå¼‚æ­¥æ£€æŸ¥è®¤è¯çŠ¶æ€ï¼Œç¡®ä¿æƒé™åŠ è½½å®Œæˆåå†æŒ‚è½½åº”ç”¨ã€‚

### Vue Devtoolsä½¿ç”¨
é€šè¿‡Vue Devtoolså¯ä»¥ï¼š
- æŸ¥çœ‹ç»„ä»¶æ ‘ç»“æ„å’Œå±‚çº§å…³ç³»
- æ£€æŸ¥ç»„ä»¶çš„propsã€dataå’Œcomputedå±æ€§
- ç›‘å¬ç»„ä»¶äº‹ä»¶çš„è§¦å‘å’Œä¼ é€’
- æŸ¥çœ‹Pinia storeçš„å½“å‰çŠ¶æ€å’Œå˜æ›´å†å²
- è·Ÿè¸ªçŠ¶æ€å˜æ›´çš„æ—¶é—´çº¿

```mermaid
graph TD
A[Vue Devtools] --> B[ç»„ä»¶é¢æ¿]
A --> C[å“åº”å¼é¢æ¿]
A --> D[æ—¶é—´çº¿é¢æ¿]
A --> E[è®¾ç½®]
B --> B1[ç»„ä»¶æ ‘]
B --> B2[Propsæ£€æŸ¥]
B --> B3[Dataæ£€æŸ¥]
B --> B4[äº‹ä»¶ç›‘å¬]
C --> C1[Pinia Store]
C --> C2[çŠ¶æ€æŸ¥çœ‹]
C --> C3[å˜æ›´å†å²]
D --> D1[äº‹ä»¶æ—¶é—´çº¿]
D --> D2[æ€§èƒ½åˆ†æ]
D --> D3[çŠ¶æ€å˜æ›´è·Ÿè¸ª]
```

**Diagram sources**
- [main.js](file://src/main.js#L1-L40)
- [App.vue](file://src/App.vue#L1-L12)

**Section sources**
- [main.js](file://src/main.js#L1-L40)

## å‰åç«¯æ•°æ®æµè°ƒè¯•
åœ¨å¤æ‚æµç¨‹å¦‚æ–‡æ¡£åŒæ­¥å’ŒAIåˆ†æä¸­ï¼Œå¯ä»¥ç»“åˆ `console.log` å’Œæ–­ç‚¹è°ƒè¯•æ¥è·Ÿè¸ªæ•°æ®æµã€‚

### æ–‡æ¡£åŒæ­¥æœåŠ¡è°ƒè¯•
`document-sync-service.js` å®ç°äº†æ–‡æ¡£åŒæ­¥åŠŸèƒ½ï¼ŒåŒ…å«å¤šä¸ªå¯è°ƒè¯•çš„å…³é”®ç‚¹ï¼š

```mermaid
flowchart TD
Start([å¼€å§‹]) --> CheckSyncing{"åŒæ­¥è¿›è¡Œä¸­?"}
CheckSyncing --> |æ˜¯| Skip["è·³è¿‡æœ¬æ¬¡æ‰§è¡Œ"]
CheckSyncing --> |å¦| SetSyncing["è®¾ç½® isSyncing = true"]
SetSyncing --> CheckHealth["æ£€æŸ¥ Open WebUI å¥åº·çŠ¶æ€"]
CheckHealth --> |ä¸å¯ç”¨| Skip
CheckHealth --> |æ­£å¸¸| QueryDocuments["æŸ¥è¯¢æœªåŒæ­¥æ–‡æ¡£"]
QueryDocuments --> CheckCount{"æ–‡æ¡£æ•°é‡ > 0?"}
CheckCount --> |å¦| NoDocs["æ— æ–‡æ¡£éœ€è¦åŒæ­¥"]
CheckCount --> |æ˜¯| LoopStart["å¼€å§‹å¾ªç¯å¤„ç†"]
LoopStart --> GetDoc["è·å–æ–‡æ¡£"]
GetDoc --> FindKB["æŸ¥æ‰¾çŸ¥è¯†åº“ID"]
FindKB --> |æœªæ‰¾åˆ°| SkipDoc["è·³è¿‡æ–‡æ¡£"]
FindKB --> |æ‰¾åˆ°| SyncDoc["åŒæ­¥æ–‡æ¡£"]
SyncDoc --> CheckSuccess{"åŒæ­¥æˆåŠŸ?"}
CheckSuccess --> |æ˜¯| IncrementSynced["æˆåŠŸè®¡æ•°+1"]
CheckSuccess --> |å¦| IncrementFailed["å¤±è´¥è®¡æ•°+1"]
IncrementSynced --> Delay["ç­‰å¾…500ms"]
IncrementFailed --> Delay
Delay --> CheckMore{"è¿˜æœ‰æ›´å¤šæ–‡æ¡£?"}
CheckMore --> |æ˜¯| LoopStart
CheckMore --> |å¦| LogStats["è¾“å‡ºç»Ÿè®¡ä¿¡æ¯"]
Skip --> End([ç»“æŸ])
NoDocs --> End
LogStats --> SetNotSyncing["è®¾ç½® isSyncing = false"]
SetNotSyncing --> End
SkipDoc --> Delay
```

**Diagram sources**
- [document-sync-service.js](file://server/services/document-sync-service.js#L1-L250)

**Section sources**
- [document-sync-service.js](file://server/services/document-sync-service.js#L1-L250)

### ä¸´æ—¶æ—¥å¿—æ·»åŠ ç¤ºä¾‹
å¯ä»¥åœ¨ `document-sync-service.js` ä¸­æ·»åŠ ä¸´æ—¶æ—¥å¿—æ¥è°ƒè¯•ç‰¹å®šæµç¨‹ï¼š

```javascript
// ========== è°ƒè¯•è¾“å‡ºï¼šæ–‡æ¡£åŒæ­¥è¯¦ç»†ä¿¡æ¯ ==========
console.log('\nğŸ“„ æ–‡æ¡£åŒæ­¥è¯¦æƒ…:');
console.log('ğŸ“ æ–‡æ¡£ID:', doc.id);
console.log('ğŸ“ æ–‡ä»¶è·¯å¾„:', doc.file_path);
console.log('ğŸ·ï¸  æ–‡ä»¶å:', doc.file_name);
console.log('ğŸ—‚ï¸  èµ„äº§ä»£ç :', doc.asset_code);
console.log('ğŸ¢ ç©ºé—´ä»£ç :', doc.space_code);
console.log('ğŸ§© è§„æ ¼ä»£ç :', doc.spec_code);
console.log('ğŸ” çŸ¥è¯†åº“ID:', kbId);
console.log('========== è°ƒè¯•è¾“å‡ºç»“æŸ ==========\n');
```

## ç«¯åˆ°ç«¯é—®é¢˜å®šä½
ç»“åˆæµè§ˆå™¨å¼€å‘è€…å·¥å…·å’ŒæœåŠ¡å™¨æ—¥å¿—è¿›è¡Œç«¯åˆ°ç«¯é—®é¢˜å®šä½æ˜¯è°ƒè¯•å¤æ‚é—®é¢˜çš„æœ‰æ•ˆæ–¹æ³•ã€‚

### è°ƒè¯•æµç¨‹
1. **å‰ç«¯è§‚å¯Ÿ**ï¼šä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„Networké¢æ¿æŸ¥çœ‹APIè¯·æ±‚å’Œå“åº”
2. **æ—¥å¿—å…³è”**ï¼šåœ¨æœåŠ¡å™¨æ—¥å¿—ä¸­æŸ¥æ‰¾å¯¹åº”çš„è¯·æ±‚å¤„ç†è®°å½•
3. **çŠ¶æ€æ£€æŸ¥**ï¼šä½¿ç”¨Vue Devtoolsæ£€æŸ¥å‰ç«¯ç»„ä»¶å’ŒPinia storeçš„çŠ¶æ€
4. **æ–­ç‚¹è°ƒè¯•**ï¼šåœ¨å…³é”®ä»£ç ç‚¹è®¾ç½®æ–­ç‚¹æˆ–æ·»åŠ  `console.log`
5. **é”™è¯¯è¿½è¸ª**ï¼šæ ¹æ®é”™è¯¯å¤„ç†ä¸­é—´ä»¶çš„è¾“å‡ºå®šä½é—®é¢˜æ ¹æº

### å·¥å…·ç»„åˆä½¿ç”¨
| å·¥å…· | ç”¨é€” | å…³é”®åŠŸèƒ½ |
|------|------|----------|
| æµè§ˆå™¨å¼€å‘è€…å·¥å…· | å‰ç«¯è°ƒè¯• | Networkè¯·æ±‚ç›‘æ§ã€Consoleæ—¥å¿—ã€Elementså…ƒç´ æ£€æŸ¥ |
| Vue Devtools | Vueåº”ç”¨è°ƒè¯• | ç»„ä»¶æ ‘ã€çŠ¶æ€ç®¡ç†ã€äº‹ä»¶è¿½è¸ª |
| æœåŠ¡å™¨æ—¥å¿— | åç«¯è°ƒè¯• | é”™è¯¯è¿½è¸ªã€æµç¨‹ç›‘æ§ã€æ€§èƒ½åˆ†æ |
| Postman | APIæµ‹è¯• | è¯·æ±‚æ„é€ ã€å“åº”éªŒè¯ã€è‡ªåŠ¨åŒ–æµ‹è¯• |

é€šè¿‡ç»¼åˆä½¿ç”¨è¿™äº›å·¥å…·ï¼Œå¯ä»¥å¿«é€Ÿå®šä½è·¨å‰åç«¯çš„å¤æ‚é—®é¢˜ï¼Œæé«˜è°ƒè¯•æ•ˆç‡ã€‚

**Section sources**
- [error-handler.js](file://server/middleware/error-handler.js#L1-L115)
- [document-sync-service.js](file://server/services/document-sync-service.js#L1-L250)
- [main.js](file://src/main.js#L1-L40)