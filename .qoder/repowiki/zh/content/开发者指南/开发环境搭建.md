# 开发环境搭建

<cite>
**本文档引用的文件**   
- [docker-compose.yml](file://docker-compose.yml)
- [.env.example](file://docker/.env.example)
- [server/.env](file://server/.env)
- [run-migration.js](file://server/run-migration.js)
- [test-db-connection.js](file://server/scripts/test-db-connection.js)
- [init-db.js](file://server/scripts/init-db.js)
- [vite.config.js](file://vite.config.js)
- [package.json](file://package.json)
- [server/package.json](file://server/package.json)
- [start.sh](file://server/start.sh)
- [start.bat](file://server/start.bat)
</cite>

## 目录
1. [环境变量配置](#环境变量配置)
2. [Docker 服务启动](#docker-服务启动)
3. [数据库初始化](#数据库初始化)
4. [数据库连接验证](#数据库连接验证)
5. [前端环境搭建](#前端环境搭建)
6. [常见问题排查](#常见问题排查)

## 环境变量配置

本项目使用环境变量文件来管理配置。您需要复制示例文件并根据您的环境进行配置。

首先，复制 `.env.example` 文件到项目根目录，并重命名为 `.env`：

```bash
cp docker/.env.example .env
```

然后，根据 `docker-compose.yml` 文件中的服务配置，设置关键参数。主要需要配置的环境变量包括：

- **GEMINI_API_KEY**: 用于 AI 功能的 Google Gemini API 密钥
- **DB_HOST**: 数据库主机地址，默认为 `localhost`
- **DB_PORT**: 数据库端口，默认为 `5432`
- **DB_NAME**: 数据库名称，默认为 `twinsight`
- **DB_USER**: 数据库用户名，默认为 `postgres`
- **DB_PASSWORD**: 数据库密码，默认为 `password`

项目根目录下的 `.env` 文件将被 Docker 和后端服务读取。同时，后端服务目录 `server/` 下也有一个 `.env` 文件，用于覆盖全局配置或设置特定于后端的变量。

**Section sources**
- [.env.example](file://docker/.env.example)
- [server/.env](file://server/.env)

## Docker 服务启动

本项目使用 Docker Compose 来管理多个服务，包括 PostgreSQL、InfluxDB、Node-RED、Grafana、n8n 和 Open WebUI。

根据 `docker-compose.yml` 文件的配置，主要服务包括：

- **PostgreSQL**: 运行在 `5432` 端口，使用 `pgvector/pgvector:pg16` 镜像，数据库名为 `twinsight`
- **InfluxDB**: 运行在 `8086` 端口，使用 `influxdb:2.7-alpine` 镜像，用于时序数据存储
- **Node-RED**: 运行在 `1880` 端口，用于 IoT 数据流程处理
- **Grafana**: 运行在 `3000` 端口，用于数据可视化
- **n8n**: 运行在 `5678` 端口，用于工作流自动化
- **Open WebUI**: 运行在 `3080` 端口，用于 AI 交互界面

要启动所有服务，请在项目根目录执行以下命令：

```bash
docker-compose up -d
```

此命令将以分离模式启动所有服务。您可以通过以下命令查看服务状态：

```bash
docker-compose ps
```

**Section sources**
- [docker-compose.yml](file://docker-compose.yml)

## 数据库初始化

在启动 Docker 服务后，需要初始化数据库 schema 和表结构。项目提供了多种方式来完成此操作。

首先，可以使用 `init-db.js` 脚本来初始化数据库。该脚本会读取 `db/schema.sql` 文件并执行其中的 SQL 语句来创建表结构。

```bash
cd server
npm run db:init
```

此外，还有一个更完整的初始化脚本 `db/init-all.sql`，它包含了所有表的创建语句和触发器。您也可以使用 `run-migration.js` 脚本来执行特定的数据库迁移任务，如添加字段等。

`run-migration.js` 脚本会加载 `.env` 文件中的环境变量，然后连接到数据库并执行指定的 SQL 迁移文件（如 `add_view_id_to_documents.sql`）。

**Section sources**
- [init-db.js](file://server/scripts/init-db.js)
- [db/init-all.sql](file://server/db/init-all.sql)
- [run-migration.js](file://server/run-migration.js)

## 数据库连接验证

为了确保后端能够正确连接到数据库，项目提供了一个验证脚本 `test-db-connection.js`。

该脚本会：
1. 加载 `.env` 文件中的环境变量
2. 使用 `pg` 模块创建数据库连接池
3. 执行 `SELECT NOW()` 查询来测试连接
4. 列出数据库中的所有表
5. 统计关键表的数据行数

运行验证脚本：

```bash
cd server
node scripts/test-db-connection.js
```

如果连接成功，您将看到类似以下的输出：
- ✅ 数据库连接成功！
- 当前时间: [当前时间]
- 当前数据库: twinsight
- 数据库中的表列表
- 各表的数据统计信息

**Section sources**
- [test-db-connection.js](file://server/scripts/test-db-connection.js)

## 前端环境搭建

前端使用 Vite 构建，需要安装依赖并启动开发服务器。

首先，安装前端依赖：

```bash
npm install
```

然后，根据 `vite.config.js` 的配置，前端开发服务器会代理 API 请求到后端服务。配置如下：
- `/api` 请求会被代理到 `http://localhost:3001`（后端服务）
- `/influx` 请求会被代理到 `http://localhost:8086`（InfluxDB）

启动前端开发服务器：

```bash
npm run dev
```

这将启动 Vite 开发服务器，默认运行在 `5173` 端口。您可以在浏览器中访问 `http://localhost:5173` 查看应用。

后端服务可以通过 `start.sh`（Linux/Mac）或 `start.bat`（Windows）脚本一键启动，这些脚本会自动检查 Node.js 环境、安装依赖（如果需要）并启动服务器。

**Section sources**
- [vite.config.js](file://vite.config.js)
- [package.json](file://package.json)
- [start.sh](file://server/start.sh)
- [start.bat](file://server/start.bat)

## 常见问题排查

### 端口冲突

如果遇到端口冲突，可能是其他服务占用了 `5432`（PostgreSQL）、`8086`（InfluxDB）或 `3001`（后端）等端口。解决方案：

1. 使用 `docker-compose ps` 检查服务状态
2. 使用 `lsof -i :端口号`（Mac/Linux）或 `netstat -ano | findstr 端口号`（Windows）查找占用端口的进程
3. 停止冲突的服务或修改 `docker-compose.yml` 中的端口映射

### 数据库连接失败

如果 `test-db-connection.js` 脚本报告连接失败，请检查：

1. Docker 服务是否正常运行：`docker-compose ps`
2. `.env` 文件中的数据库配置是否正确
3. 数据库容器是否已完全启动（可能需要等待几秒钟）
4. 网络连接是否正常

### 依赖安装失败

如果 `npm install` 失败，可能是网络问题。可以尝试：

1. 使用国内镜像源：`npm config set registry https://registry.npmmirror.com`
2. 清除 npm 缓存：`npm cache clean --force`
3. 重新安装

### 环境变量未生效

确保 `.env` 文件位于正确的目录：
- Docker 服务读取项目根目录的 `.env` 文件
- 后端服务优先读取 `server/.env` 文件，然后是根目录的 `.env` 文件

**Section sources**
- [docker-compose.yml](file://docker-compose.yml)
- [.env.example](file://docker/.env.example)
- [server/.env](file://server/.env)