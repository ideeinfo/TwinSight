# 组合式函数

<cite>
**本文档引用的文件**   
- [useTimeline.ts](file://src/composables/useTimeline.ts)
- [useViewState.ts](file://src/composables/useViewState.ts)
- [useIoTData.ts](file://src/composables/useIoTData.ts)
- [useSelection.ts](file://src/composables/useSelection.ts)
- [useViewer.ts](file://src/composables/useViewer.ts)
- [useHeatmap.ts](file://src/composables/useHeatmap.ts)
- [useDataExport.ts](file://src/composables/useDataExport.ts)
- [useAppState.ts](file://src/composables/useAppState.ts)
- [index.ts](file://src/composables/index.ts)
- [iot.ts](file://src/stores/iot.ts)
- [assets.ts](file://src/stores/assets.ts)
- [spaces.ts](file://src/stores/spaces.ts)
- [AppViewer.vue](file://src/AppViewer.vue)
</cite>

## 目录
1. [引言](#引言)
2. [核心组合式函数设计原理](#核心组合式函数设计原理)
3. [useTimeline：时间轴控制逻辑](#usetimeline时间轴控制逻辑)
4. [useViewState：三维视图状态管理](#useviewstate三维视图状态管理)
5. [useIoTData：物联网数据处理](#useiotdata物联网数据处理)
6. [useSelection：资产与空间选择逻辑](#useselection资产与空间选择逻辑)
7. [高级话题：类型推导与性能监控](#高级话题类型推导与性能监控)
8. [组合式函数调用示例](#组合式函数调用示例)
9. [结论](#结论)

## 引言
组合式函数（Composables）是Vue 3中用于逻辑复用的核心模式，它通过`ref`、`reactive`、`watch`等响应式API将可复用的业务逻辑封装成独立的函数。在本项目中，组合式函数被广泛应用于三维查看器的状态管理、时间轴控制、物联网数据处理等复杂场景，有效简化了组件的逻辑复杂度，提升了代码的可维护性和可测试性。本文将深入分析`composables/`目录下的核心函数，探讨其设计原理与内部实现。

## 核心组合式函数设计原理
组合式函数的设计遵循单一职责原则，每个函数专注于解决特定的业务问题。通过将状态和逻辑封装在函数内部，组合式函数实现了逻辑的高内聚和低耦合。在本项目中，组合式函数通过`ref`和`computed`创建响应式状态，通过`watch`监听状态变化并执行副作用，通过返回对象暴露状态和方法供组件使用。这种设计模式使得组件可以专注于UI渲染，而将复杂的业务逻辑委托给组合式函数处理。

**Section sources**
- [useTimeline.ts](file://src/composables/useTimeline.ts#L20-L359)
- [useViewState.ts](file://src/composables/useViewState.ts#L43-L255)
- [useIoTData.ts](file://src/composables/useIoTData.ts#L20-L172)
- [useSelection.ts](file://src/composables/useSelection.ts#L9-L141)

## useTimeline：时间轴控制逻辑
`useTimeline`函数封装了时间轴的控制逻辑，包括播放、暂停、快进、倒退、循环播放等功能。它通过`ref`创建了`isPlaying`、`playbackSpeed`、`progress`等响应式状态，并通过`computed`计算了`isLive`、`rangeDurationMs`等派生状态。函数内部通过`setInterval`实现播放逻辑，根据播放速度更新当前时间，并同步到`iotStore`中。`useTimeline`还提供了`startDrag`方法，支持用户通过鼠标拖拽调整时间轴位置。

```mermaid
classDiagram
class useTimeline {
+ref isOpen
+ref isPlaying
+ref isLooping
+ref playbackSpeed
+ref progress
+ref rangeStartMs
+ref rangeEndMs
+ref currentTimeMs
+ref selectedTimeRange
+computed isLive
+computed rangeDurationMs
+computed selectedTimeRangeLabel
+computed currentDateStr
+computed currentTimeStr
+function openTimeline()
+function closeTimeline()
+function togglePlay()
+function startPlayback()
+function stopPlayback()
+function goLive()
+function selectTimeRange()
+function setCustomRange()
+function cycleSpeed()
+function zoomIn()
+function zoomOut()
+function panTimeline()
+function startDrag()
+function seekTo()
+function getTimeRange()
}
```

**Diagram sources **
- [useTimeline.ts](file://src/composables/useTimeline.ts#L20-L359)

**Section sources**
- [useTimeline.ts](file://src/composables/useTimeline.ts#L20-L359)

## useViewState：三维视图状态管理
`useViewState`函数负责管理三维查看器的视图状态，包括获取当前视图状态、截取屏幕快照、恢复视图状态等。它通过`getViewer`函数获取查看器实例，并通过`getState`和`restoreState` API实现视图状态的保存与恢复。为了确保视图恢复的准确性，函数在恢复前会重置`WorldUpVector`为Z轴向上，并删除保存的`worldUpVector`，避免坐标系变化导致的显示异常。`useViewState`还支持热力图和标签的显示状态管理，确保恢复视图时这些设置也能正确应用。

```mermaid
classDiagram
class useViewState {
+function getViewerState()
+function captureScreenshot()
+function restoreViewState()
+function getIsRestoringView()
}
class ViewerInstance {
+function getState()
+function restoreState()
+function getScreenShot()
+function getIsolatedNodes()
+function isolate()
+navigation
+impl
}
useViewState --> ViewerInstance : "uses"
```

**Diagram sources **
- [useViewState.ts](file://src/composables/useViewState.ts#L43-L255)

**Section sources**
- [useViewState.ts](file://src/composables/useViewState.ts#L43-L255)

## useIoTData：物联网数据处理
`useIoTData`函数封装了物联网数据的获取和处理逻辑，包括温度数据的获取、热力图颜色计算、时间轴控制等。它通过`useIoTStore`获取全局状态，并通过`computed`创建了`isTimelineOpen`、`isLive`、`isPlaying`等派生状态。函数内部通过`temperatureToColor`方法将温度值转换为热力图颜色，支持自定义温度范围和颜色映射。`useIoTData`还提供了`toggleTimeline`、`goLive`、`togglePlayback`等方法，用于控制时间轴的显示和播放状态。

```mermaid
classDiagram
class useIoTData {
+computed isTimelineOpen
+computed isLive
+computed isPlaying
+computed playbackSpeed
+computed currentTimeMs
+computed rangeStartMs
+computed rangeEndMs
+computed isHeatmapEnabled
+computed roomTags
+computed hasInfluxConfig
+function toggleTimeline()
+function goLive()
+function togglePlayback()
+function setPlaybackSpeed()
+function setTimeRange()
+function setCurrentTime()
+function toggleHeatmap()
+function setRoomTags()
+function updateRoomTag()
+function temperatureToColor()
}
class IoTStore {
+state isTimelineOpen
+state isLive
+state isPlaying
+state playbackSpeed
+state rangeStartMs
+state rangeEndMs
+state currentTimeMs
+state roomTags
+state isHeatmapEnabled
+state influxConfig
+action toggleTimeline()
+action goLive()
+action togglePlayback()
+action setPlaybackSpeed()
+action setTimeRange()
+action setCurrentTime()
+action toggleHeatmap()
+action setRoomTags()
+action updateRoomTag()
}
useIoTData --> IoTStore : "uses"
```

**Diagram sources **
- [useIoTData.ts](file://src/composables/useIoTData.ts#L20-L172)
- [iot.ts](file://src/stores/iot.ts#L53-L205)

**Section sources**
- [useIoTData.ts](file://src/composables/useIoTData.ts#L20-L172)
- [iot.ts](file://src/stores/iot.ts#L53-L205)

## useSelection：资产与空间选择逻辑
`useSelection`函数封装了资产和空间的选择逻辑，包括选择、取消选择、切换选择、清除选择等操作。它通过`useAssetsStore`和`useSpacesStore`获取资产和空间的状态，并通过`computed`创建了`selectedAssetIds`、`selectedAssetDbIds`、`selectedAssets`等派生状态。函数内部通过`selectAsset`、`deselectAsset`、`toggleAsset`等方法实现选择逻辑，并通过`clearAllSelection`方法清除所有选择。`useSelection`还支持根据`dbId`批量选择资产或空间，提高了选择操作的效率。

```mermaid
classDiagram
class useSelection {
+computed selectedAssetIds
+computed selectedAssetDbIds
+computed selectedAssets
+computed selectedSpaceIds
+computed selectedSpaceDbIds
+computed selectedSpaces
+function selectAsset()
+function deselectAsset()
+function toggleAsset()
+function clearAssetSelection()
+function selectAssetsByDbIds()
+function selectSpace()
+function deselectSpace()
+function toggleSpace()
+function clearSpaceSelection()
+function selectSpacesByDbIds()
+function clearAllSelection()
}
class AssetsStore {
+state list
+state selectedIds
+state selectedDbIds
+action selectAsset()
+action deselectAsset()
+action toggleAsset()
+action clearSelection()
}
class SpacesStore {
+state list
+state selectedIds
+state selectedDbIds
+action selectSpace()
+action deselectSpace()
+action toggleSpace()
+action clearSelection()
}
useSelection --> AssetsStore : "uses"
useSelection --> SpacesStore : "uses"
```

**Diagram sources **
- [useSelection.ts](file://src/composables/useSelection.ts#L9-L141)
- [assets.ts](file://src/stores/assets.ts#L39-L173)
- [spaces.ts](file://src/stores/spaces.ts#L29-L166)

**Section sources**
- [useSelection.ts](file://src/composables/useSelection.ts#L9-L141)
- [assets.ts](file://src/stores/assets.ts#L39-L173)
- [spaces.ts](file://src/stores/spaces.ts#L29-L166)

## 高级话题：类型推导与性能监控
在组合式函数的设计中，类型推导和性能监控是两个重要的高级话题。通过TypeScript的泛型和接口，组合式函数可以实现精确的类型推导，提高代码的可读性和可维护性。例如，`useTimeline`函数通过`TimeRange`和`TimeOption`接口定义了时间范围和时间选项的类型，确保了参数和返回值的类型安全。在性能监控方面，组合式函数通过`watch`的`flush`选项控制副作用的执行时机，避免不必要的计算和渲染。此外，通过`shallowRef`和`markRaw`等API，可以优化响应式系统的性能，减少不必要的依赖追踪。

**Section sources**
- [useTimeline.ts](file://src/composables/useTimeline.ts#L8-L18)
- [useViewState.ts](file://src/composables/useViewState.ts#L13-L41)
- [useIoTData.ts](file://src/composables/useIoTData.ts#L8-L17)

## 组合式函数调用示例
在`AppViewer.vue`组件中，多个组合式函数被同时使用，展示了组合式函数的强大复用能力。组件通过`useTimeline`、`useViewState`、`useIoTData`、`useSelection`等函数获取了时间轴、视图状态、物联网数据、选择状态等逻辑，并通过`v-model`和事件绑定将这些状态和方法应用到UI组件中。这种组合式函数的调用方式使得组件的逻辑清晰、代码简洁，易于维护和扩展。

```mermaid
sequenceDiagram
participant AppViewer as AppViewer.vue
participant useTimeline as useTimeline()
participant useViewState as useViewState()
participant useIoTData as useIoTData()
participant useSelection as useSelection()
AppViewer->>useTimeline : 调用函数
useTimeline-->>AppViewer : 返回状态和方法
AppViewer->>useViewState : 调用函数
useViewState-->>AppViewer : 返回状态和方法
AppViewer->>useIoTData : 调用函数
useIoTData-->>AppViewer : 返回状态和方法
AppViewer->>useSelection : 调用函数
useSelection-->>AppViewer : 返回状态和方法
AppViewer->>AppViewer : 组合状态和方法
AppViewer->>UI : 更新UI
```

**Diagram sources **
- [AppViewer.vue](file://src/AppViewer.vue#L162-L800)

**Section sources**
- [AppViewer.vue](file://src/AppViewer.vue#L162-L800)

## 结论
组合式函数是Vue 3中实现逻辑复用的强大工具，通过将可复用的业务逻辑封装成独立的函数，可以有效简化组件的复杂度，提升代码的可维护性和可测试性。在本项目中，`useTimeline`、`useViewState`、`useIoTData`、`useSelection`等组合式函数被广泛应用于三维查看器的状态管理、时间轴控制、物联网数据处理等复杂场景，展示了组合式函数在实际项目中的强大应用价值。通过深入理解组合式函数的设计原理和内部实现，开发者可以更好地利用这一模式，构建高效、可维护的前端应用。