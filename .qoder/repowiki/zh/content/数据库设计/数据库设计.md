# 数据库设计

<cite>
**本文档引用的文件**   
- [schema.sql](file://server/db/schema.sql)
- [init-all.sql](file://server/db/init-all.sql)
- [asset.js](file://server/models/asset.js)
- [space.js](file://server/models/space.js)
- [document.js](file://server/models/document.js)
- [view.js](file://server/models/view.js)
- [mapping-config.js](file://server/models/mapping-config.js)
- [influx-config.js](file://server/models/influx-config.js)
- [model-file.js](file://server/models/model-file.js)
- [create_mapping_config.sql](file://server/db/migrations/create_mapping_config.sql)
- [add_mapping_config_fk.sql](file://server/db/migrations/add_mapping_config_fk.sql)
- [extend_field_lengths.sql](file://server/db/migrations/extend_field_lengths.sql)
- [reset_railway_db.sql](file://server/db/migrations/reset_railway_db.sql)
</cite>

## 目录
1. [引言](#引言)
2. [核心表结构](#核心表结构)
3. [实体关系图](#实体关系图)
4. [Sequelize模型映射](#sequelize模型映射)
5. [数据库迁移策略](#数据库迁移策略)
6. [数据完整性与性能优化](#数据完整性与性能优化)
7. [结论](#结论)

## 引言
本文档详细描述了TwinSight系统的PostgreSQL数据库设计。基于`schema.sql`和`init-all.sql`文件，本文档全面介绍了核心表的结构、关系、约束和索引。同时，文档解释了`models/`目录下的Sequelize模型文件如何与数据库表进行映射，并阐述了使用`db/migrations/`目录中SQL脚本进行数据库模式变更的迁移策略。最后，文档讨论了数据完整性保障措施和性能优化方案。

## 核心表结构
本节详细描述了`schema.sql`和`init-all.sql`中定义的核心表结构，包括字段、数据类型、主键、外键约束、索引和非空约束。

### assets (资产表)
存储资产构件的基本信息。

**字段定义:**
- `id`: SERIAL, 主键, 自增
- `uuid`: UUID, 默认值 `gen_random_uuid()`, 非空, 唯一索引 `idx_assets_uuid`
- `file_id`: INTEGER, 外键引用 `model_files(id)`，级联删除
- `asset_code`: VARCHAR(100), 非空, 唯一约束 `(file_id, asset_code)`
- `spec_code`: VARCHAR(100), 外键引用 `asset_specs(spec_code)`
- `name`: VARCHAR(200)
- `floor`: VARCHAR(100)
- `room`: VARCHAR(200)
- `db_id`: INTEGER, 用于与Viewer关联
- `created_at`: TIMESTAMP, 默认值 `CURRENT_TIMESTAMP`
- `updated_at`: TIMESTAMP, 默认值 `CURRENT_TIMESTAMP`

**索引:**
- `idx_assets_spec_code` on `spec_code`
- `idx_assets_floor` on `floor`
- `idx_assets_room` on `room`
- `idx_assets_db_id` on `db_id`

**约束:**
- 主键: `id`
- 唯一约束: `(file_id, asset_code)`
- 外键: `file_id` -> `model_files(id)` (ON DELETE CASCADE)
- 非空: `asset_code`, `uuid`

**Section sources**
- [schema.sql](file://server/db/schema.sql#L39-L54)
- [init-all.sql](file://server/db/init-all.sql#L69-L83)

### spaces (空间表)
存储房间构件的基本信息。

**字段定义:**
- `id`: SERIAL, 主键, 自增
- `uuid`: UUID, 默认值 `gen_random_uuid()`, 非空, 唯一索引 `idx_spaces_uuid`
- `file_id`: INTEGER, 外键引用 `model_files(id)`，级联删除
- `space_code`: VARCHAR(100), 非空, 唯一约束 `(file_id, space_code)`
- `name`: VARCHAR(200)
- `classification_code`: VARCHAR(100)
- `classification_desc`: VARCHAR(500)
- `floor`: VARCHAR(100)
- `area`: DECIMAL(15, 4)
- `perimeter`: DECIMAL(15, 4)
- `db_id`: INTEGER, 用于与Viewer关联
- `created_at`: TIMESTAMP, 默认值 `CURRENT_TIMESTAMP`
- `updated_at`: TIMESTAMP, 默认值 `CURRENT_TIMESTAMP`

**索引:**
- `idx_spaces_classification` on `classification_code`
- `idx_spaces_floor` on `floor`
- `idx_spaces_db_id` on `db_id`

**约束:**
- 主键: `id`
- 唯一约束: `(file_id, space_code)`
- 外键: `file_id` -> `model_files(id)` (ON DELETE CASCADE)
- 非空: `space_code`, `uuid`

**Section sources**
- [schema.sql](file://server/db/schema.sql#L56-L73)
- [init-all.sql](file://server/db/init-all.sql#L111-L128)

### documents (文档表)
存储与资产、空间、视图等关联的文档信息。

**字段定义:**
- `id`: SERIAL, 主键, 自增
- `title`: VARCHAR(255), 非空
- `file_name`: VARCHAR(255), 非空
- `file_path`: VARCHAR(500), 非空
- `file_size`: INTEGER
- `file_type`: VARCHAR(50)
- `mime_type`: VARCHAR(100)
- `asset_code`: VARCHAR(100), 外键引用 `assets(asset_code)`
- `space_code`: VARCHAR(100), 外键引用 `spaces(space_code)`
- `spec_code`: VARCHAR(100), 外键引用 `asset_specs(spec_code)`
- `view_id`: INTEGER, 外键引用 `views(id)`，删除时设为NULL
- `openwebui_file_id`: VARCHAR(255)
- `created_at`: TIMESTAMP, 默认值 `CURRENT_TIMESTAMP`
- `updated_at`: TIMESTAMP, 默认值 `CURRENT_TIMESTAMP`

**索引:**
- `idx_documents_asset` on `asset_code`
- `idx_documents_space` on `space_code`
- `idx_documents_spec` on `spec_code`
- `idx_documents_created` on `created_at DESC`

**约束:**
- 主键: `id`
- 外键: `view_id` -> `views(id)` (ON DELETE SET NULL)
- 非空: `title`, `file_name`, `file_path`

**Section sources**
- [init-all.sql](file://server/db/init-all.sql#L186-L209)

### views (视图表)
存储模型的视图状态，如相机位置、隔离状态等。

**字段定义:**
- `id`: SERIAL, 主键, 自增
- `file_id`: INTEGER, 非空, 外键引用 `model_files(id)`，级联删除
- `name`: VARCHAR(255), 非空, 唯一约束 `(file_id, name)`
- `thumbnail`: TEXT
- `camera_state`: JSONB
- `isolation_state`: JSONB
- `selection_state`: JSONB
- `theming_state`: JSONB
- `environment`: VARCHAR(100)
- `cutplanes`: JSONB
- `explode_scale`: DOUBLE PRECISION
- `render_options`: JSONB
- `other_settings`: JSONB
- `viewer_state`: JSONB
- `is_default`: BOOLEAN, 默认值 `FALSE`
- `created_at`: TIMESTAMP, 默认值 `CURRENT_TIMESTAMP`
- `updated_at`: TIMESTAMP, 默认值 `CURRENT_TIMESTAMP`

**索引:**
- `idx_views_file_id` on `file_id`
- `idx_views_name` on `name`
- `idx_views_created` on `created_at DESC`

**约束:**
- 主键: `id`
- 唯一约束: `(file_id, name)`
- 外键: `file_id` -> `model_files(id)` (ON DELETE CASCADE)
- 非空: `file_id`, `name`

**Section sources**
- [init-all.sql](file://server/db/init-all.sql#L157-L184)

### mapping_config (映射配置表)
存储模型文件的字段映射配置，用于将模型中的字段映射到系统属性。

**字段定义:**
- `id`: SERIAL, 主键, 自增
- `file_id`: INTEGER, 非空, 外键引用 `model_files(id)`，级联删除
- `config_type`: VARCHAR(50), 非空, 取值为 'asset', 'asset_spec', 'space'
- `field_name`: VARCHAR(100), 非空
- `category`: VARCHAR(200)
- `property`: VARCHAR(200)
- `created_at`: TIMESTAMP, 默认值 `CURRENT_TIMESTAMP`
- `updated_at`: TIMESTAMP, 默认值 `CURRENT_TIMESTAMP`

**索引:**
- `idx_mapping_configs_file_id` on `file_id`
- `idx_mapping_configs_type` on `config_type`

**约束:**
- 主键: `id`
- 唯一约束: `(file_id, config_type, field_name)`
- 外键: `file_id` -> `model_files(id)` (ON DELETE CASCADE)
- 非空: `file_id`, `config_type`, `field_name`

**Section sources**
- [init-all.sql](file://server/db/init-all.sql#L234-L251)
- [create_mapping_config.sql](file://server/db/migrations/create_mapping_config.sql)

### influx_configs (InfluxDB配置表)
存储每个模型的时序数据库连接配置。

**字段定义:**
- `id`: SERIAL, 主键, 自增
- `file_id`: INTEGER, 唯一, 外键引用 `model_files(id)`，级联删除
- `influx_url`: VARCHAR(500), 非空
- `influx_port`: INTEGER, 默认值 8086
- `influx_org`: VARCHAR(200), 非空
- `influx_bucket`: VARCHAR(200), 非空
- `influx_token`: TEXT
- `influx_user`: VARCHAR(200)
- `influx_password`: TEXT
- `use_basic_auth`: BOOLEAN, 默认值 `false`
- `is_enabled`: BOOLEAN, 默认值 `true`
- `created_at`: TIMESTAMP, 默认值 `CURRENT_TIMESTAMP`
- `updated_at`: TIMESTAMP, 默认值 `CURRENT_TIMESTAMP`

**索引:**
- `idx_influx_configs_file_id` on `file_id`

**约束:**
- 主键: `id`
- 唯一约束: `file_id`
- 外键: `file_id` -> `model_files(id)` (ON DELETE CASCADE)
- 非空: `influx_url`, `influx_org`, `influx_bucket`

**Section sources**
- [schema.sql](file://server/db/schema.sql#L103-L123)
- [init-all.sql](file://server/db/init-all.sql#L136-L156)

## 实体关系图
以下Mermaid图展示了核心表之间的关系。

```mermaid
erDiagram
model_files {
integer id PK
varchar file_code UK
varchar title
boolean is_active
timestamp created_at
timestamp updated_at
}
assets {
integer id PK
uuid uuid UK
integer file_id FK
varchar asset_code
varchar spec_code FK
varchar name
varchar floor
varchar room
integer db_id
timestamp created_at
timestamp updated_at
}
spaces {
integer id PK
uuid uuid UK
integer file_id FK
varchar space_code
varchar name
varchar classification_code
varchar classification_desc
varchar floor
decimal area
decimal perimeter
integer db_id
timestamp created_at
timestamp updated_at
}
documents {
integer id PK
varchar title
varchar file_name
varchar file_path
integer file_size
varchar file_type
varchar mime_type
varchar asset_code FK
varchar space_code FK
varchar spec_code FK
integer view_id FK
varchar openwebui_file_id
timestamp created_at
timestamp updated_at
}
views {
integer id PK
integer file_id FK
varchar name
text thumbnail
jsonb viewer_state
boolean is_default
timestamp created_at
timestamp updated_at
}
mapping_configs {
integer id PK
integer file_id FK
varchar config_type
varchar field_name
varchar category
varchar property
timestamp created_at
timestamp updated_at
}
influx_configs {
integer id PK
integer file_id UK FK
varchar influx_url
integer influx_port
varchar influx_org
varchar influx_bucket
text influx_token
varchar influx_user
text influx_password
boolean use_basic_auth
boolean is_enabled
timestamp created_at
timestamp updated_at
}
model_files ||--o{ assets : "1 to many"
model_files ||--o{ spaces : "1 to many"
model_files ||--o{ views : "1 to many"
model_files ||--o{ mapping_configs : "1 to many"
model_files ||--o{ influx_configs : "1 to 1"
assets ||--o{ documents : "1 to many"
spaces ||--o{ documents : "1 to many"
views ||--o{ documents : "1 to many"
```

**Diagram sources**
- [schema.sql](file://server/db/schema.sql)
- [init-all.sql](file://server/db/init-all.sql)

## Sequelize模型映射
`models/`目录下的JavaScript文件定义了Sequelize模型，这些模型直接映射到数据库表。每个模型文件提供了对相应表的CRUD操作。

### 资产模型 (asset.js)
`asset.js`文件定义了与`assets`表交互的数据访问对象（DAO）。它提供了插入、更新、查询和删除资产的方法。例如，`batchUpsertAssetsWithFile`函数用于批量插入资产，并通过`file_id`将资产与特定的模型文件关联。

**Section sources**
- [asset.js](file://server/models/asset.js)

### 空间模型 (space.js)
`space.js`文件定义了与`spaces`表交互的DAO。它提供了类似`batchUpsertSpacesWithFile`的批量操作，以及根据楼层或分类编码查询空间的方法。

**Section sources**
- [space.js](file://server/models/space.js)

### 文档模型 (document.js)
`document.js`文件定义了与`documents`表交互的DAO。`getDocuments`函数可以根据`assetCode`、`spaceCode`、`specCode`或`viewId`获取关联的文档列表。

**Section sources**
- [document.js](file://server/models/document.js)

### 视图模型 (view.js)
`view.js`文件定义了与`views`表交互的DAO。`createView`和`updateView`函数处理JSONB字段（如`viewer_state`）的序列化和反序列化。

**Section sources**
- [view.js](file://server/models/view.js)

### 映射配置模型 (mapping-config.js)
`mapping-config.js`文件定义了与`mapping_configs`表交互的DAO。`getMappingConfig`函数将数据库中的扁平化记录转换为前端所需的嵌套对象格式（`assetMapping`, `assetSpecMapping`, `spaceMapping`）。`saveMappingConfig`函数则执行相反的转换，并在一个事务中删除旧配置并插入新配置。

**Section sources**
- [mapping-config.js](file://server/models/mapping-config.js)

### InfluxDB配置模型 (influx-config.js)
`influx-config.js`文件定义了与`influx_configs`表交互的DAO。`saveInfluxConfig`函数会检查配置是否存在，如果存在则更新，否则插入新记录。

**Section sources**
- [influx-config.js](file://server/models/influx-config.js)

## 数据库迁移策略
数据库模式的变更通过`db/migrations/`目录中的SQL脚本进行管理。这些脚本按顺序执行，以确保数据库结构的演进。

### 迁移脚本示例
- `create_mapping_config.sql`: 创建`mapping_configs`表，但暂时不添加外键约束，以避免因依赖顺序导致的错误。
- `add_mapping_config_fk.sql`: 在`model_files`表创建后，为`mapping_configs`表添加外键约束。此脚本首先检查并删除可能存在的旧约束，然后添加新的级联删除外键。
- `extend_field_lengths.sql`: 使用`ALTER TABLE ... ALTER COLUMN ... TYPE`语句修改现有表的字段长度，以适应更长的值。
- `reset_railway_db.sql`: 一个高风险的迁移脚本，用于在生产环境出现问题时重置数据库。它按依赖顺序反向删除所有表，然后需要手动运行`init-all.sql`来重新创建。

**Section sources**
- [create_mapping_config.sql](file://server/db/migrations/create_mapping_config.sql)
- [add_mapping_config_fk.sql](file://server/db/migrations/add_mapping_config_fk.sql)
- [extend_field_lengths.sql](file://server/db/migrations/extend_field_lengths.sql)
- [reset_railway_db.sql](file://server/db/migrations/reset_railway_db.sql)

## 数据完整性与性能优化
### 数据完整性保障
数据库通过多种机制保障数据完整性：
- **外键约束**: 所有与`model_files`表关联的子表（如`assets`, `spaces`, `views`）都设置了`ON DELETE CASCADE`，确保当一个模型文件被删除时，其所有相关数据也会被自动清除。
- **唯一约束**: 在`assets`和`spaces`表上，`(file_id, asset_code)`和`(file_id, space_code)`的组合确保了在同一个模型文件内，资产和空间的编码是唯一的。
- **触发器**: `update_updated_at_column`触发器在每次更新记录时自动更新`updated_at`字段，确保数据的时效性。

### 性能优化
- **索引**: 在频繁查询的字段上创建了索引，例如`assets`表的`spec_code`、`floor`和`room`字段，`spaces`表的`classification_code`和`floor`字段，以及`documents`表的`asset_code`、`space_code`和`created_at`字段。这些索引显著提高了查询性能。
- **UUID主键**: `assets`、`spaces`等表使用UUID作为主键，这有助于在分布式系统中生成全局唯一标识符，避免了自增ID可能带来的冲突。

**Section sources**
- [schema.sql](file://server/db/schema.sql)
- [init-all.sql](file://server/db/init-all.sql)

## 结论
TwinSight的数据库设计清晰地反映了其核心数据模型。通过`model_files`作为中心表，其他实体（资产、空间、视图等）都与之关联，形成了一个以模型文件为核心的星型结构。Sequelize模型文件提供了与数据库交互的清晰接口，而SQL迁移脚本则确保了数据库模式的可管理性和可追溯性。外键约束和索引的合理使用，保证了数据的完整性和查询的高效性。