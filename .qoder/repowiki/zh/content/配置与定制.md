# é…ç½®ä¸å®šåˆ¶

<cite>
**æœ¬æ–‡æ¡£ä¸­å¼•ç”¨çš„æ–‡ä»¶**   
- [.env](file://.env)
- [.env.local](file://.env.local)
- [server/.env](file://server/.env)
- [vite.config.js](file://vite.config.js)
- [src/services/influx.ts](file://src/services/influx.ts)
- [src/services/postgres.js](file://src/services/postgres.js)
- [server/db/index.js](file://server/db/index.js)
- [server/index.js](file://server/index.js)
</cite>

## ç›®å½•
1. [é¡¹ç›®é…ç½®æ¦‚è¿°](#é¡¹ç›®é…ç½®æ¦‚è¿°)
2. [.envæ–‡ä»¶é…ç½®è¯¦è§£](#envæ–‡ä»¶é…ç½®è¯¦è§£)
3. ç¯å¢ƒå˜é‡è¦†ç›–æœºåˆ¶
4. Viteæ„å»ºé…ç½®
5. é…ç½®æœ€ä½³å®è·µ
6. å¸¸è§é—®é¢˜æ’æŸ¥
7. å®‰å…¨å»ºè®®

## é¡¹ç›®é…ç½®æ¦‚è¿°

æœ¬é¡¹ç›®é‡‡ç”¨å¤šå±‚é…ç½®ä½“ç³»ï¼Œé€šè¿‡ç¯å¢ƒå˜é‡æ–‡ä»¶å’Œæ„å»ºé…ç½®æ–‡ä»¶å®ç°çµæ´»çš„ç³»ç»Ÿå®šåˆ¶ã€‚é…ç½®ä½“ç³»ä¸»è¦åŒ…æ‹¬ï¼š
- æ ¹ç›®å½•ä¸‹çš„`.env`å’Œ`.env.local`æ–‡ä»¶ï¼Œç”¨äºå‰ç«¯Viteåº”ç”¨çš„ç¯å¢ƒé…ç½®
- `server/`ç›®å½•ä¸‹çš„`.env`æ–‡ä»¶ï¼Œç”¨äºåç«¯æœåŠ¡å™¨çš„ç¯å¢ƒé…ç½®
- `vite.config.js`æ–‡ä»¶ï¼Œç”¨äºViteæ„å»ºå·¥å…·çš„å¼€å‘æœåŠ¡å™¨å’Œä»£ç†é…ç½®

è¿™ç§åˆ†å±‚é…ç½®æ–¹å¼ä½¿å¾—å‰ç«¯å’Œåç«¯å¯ä»¥ç‹¬ç«‹é…ç½®å„è‡ªçš„è¿æ¥å‚æ•°ï¼ŒåŒæ—¶é€šè¿‡Viteçš„ä»£ç†åŠŸèƒ½å®ç°å¼€å‘ç¯å¢ƒä¸‹çš„æ— ç¼é›†æˆã€‚

**Section sources**
- [.env](file://.env#L1-L6)
- [server/.env](file://server/.env#L1-L19)
- [vite.config.js](file://vite.config.js#L1-L21)

## .envæ–‡ä»¶é…ç½®è¯¦è§£

### æ ¹ç›®å½•.envæ–‡ä»¶

æ ¹ç›®å½•ä¸‹çš„`.env`æ–‡ä»¶ä¸»è¦ç”¨äºé…ç½®å‰ç«¯åº”ç”¨çš„ç¯å¢ƒå˜é‡ï¼Œç‰¹åˆ«æ˜¯ä¸InfluxDBæ—¶åºæ•°æ®åº“çš„è¿æ¥é…ç½®ï¼š

```env
# InfluxDB é…ç½® (å‰ç«¯ç›´æ¥æŸ¥è¯¢)
VITE_INFLUX_URL=http://localhost:8086
VITE_INFLUX_ORG=demo
VITE_INFLUX_BUCKET=tandem
VITE_INFLUX_TOKEN=Wutfd7wGE9HowTtyZp6uX2Y7xLucD3iB8AFh0VWeUdlRxllw5Oljah6fO-aXDAc3U-ROIo4rBvVSXSDgXT7-rA==
```

è¿™äº›ç¯å¢ƒå˜é‡é€šè¿‡Viteçš„`import.meta.env`åœ¨å‰ç«¯ä»£ç ä¸­ä½¿ç”¨ï¼Œä¸»è¦ç”¨äºæ—¶åºæ•°æ®çš„æŸ¥è¯¢å’Œå†™å…¥æ“ä½œã€‚

**Section sources**
- [.env](file://.env#L1-L6)
- [src/services/influx.ts](file://src/services/influx.ts#L1-L136)

### .env.localæ–‡ä»¶

`.env.local`æ–‡ä»¶æ˜¯æœ¬åœ°ç¯å¢ƒçš„é…ç½®æ–‡ä»¶ï¼Œå…·æœ‰æœ€é«˜ä¼˜å…ˆçº§ï¼Œç”¨äºè¦†ç›–å…¶ä»–.envæ–‡ä»¶ä¸­çš„é…ç½®ï¼š

```env
VITE_INFLUX_URL=/influx
VITE_INFLUX_TOKEN=db86a771bdf34e26b5dbb75efdf04391
VITE_INFLUX_ORG=demo
VITE_INFLUX_BUCKET=tandem
VITE_INFLUX_BASIC=false
VITE_INFLUX_USER=root
VITE_INFLUX_PASSWORD=rootroot

# PostgreSQL æ•°æ®åº“é…ç½®
DB_HOST=localhost
DB_PORT=5432
DB_NAME=tandem
DB_USER=postgres
DB_PASSWORD=password
```

æ­¤æ–‡ä»¶åŒ…å«äº†å‰ç«¯å’Œåç«¯å…±ç”¨çš„æ•°æ®åº“è¿æ¥é…ç½®ï¼Œä»¥åŠInfluxDBçš„è¯¦ç»†è®¤è¯ä¿¡æ¯ã€‚

**Section sources**
- [.env.local](file://.env.local#L1-L15)

### server/.envæ–‡ä»¶

`server/`ç›®å½•ä¸‹çš„`.env`æ–‡ä»¶ä¸“é—¨ç”¨äºåç«¯æœåŠ¡å™¨çš„é…ç½®ï¼š

```env
# PostgreSQL æ•°æ®åº“é…ç½®
DB_HOST=localhost
DB_PORT=5432
DB_NAME=tandem
DB_USER=postgres
DB_PASSWORD=password

# æœåŠ¡å™¨é…ç½®
SERVER_PORT=3001

# InfluxDB é…ç½® (ç”¨äºæ—¶åºæ•°æ®)
INFLUX_URL=http://localhost:8086
INFLUX_ORG=demo
INFLUX_BUCKET=tandem
INFLUX_TOKEN=Wutfd7wGE9HowTtyZp6uX2Y7xLucD3iB8AFh0VWeUdlRxllw5Oljah6fO-aXDAc3U-ROIo4rBvVSXSDgXT7-rA==

# API å¯†é’¥é…ç½® (ç”¨äºç”Ÿæˆ Stream URL çš„å®‰å…¨ Key)
API_KEY_SECRET=tandem-timeseries-secret-2024
```

è¿™äº›é…ç½®åœ¨`server/index.js`å’Œ`server/db/index.js`ä¸­é€šè¿‡`process.env`è®¿é—®ï¼Œç”¨äºå»ºç«‹æ•°æ®åº“è¿æ¥å’Œå¯åŠ¨æœåŠ¡å™¨ã€‚

**Section sources**
- [server/.env](file://server/.env#L1-L19)
- [server/db/index.js](file://server/db/index.js#L1-L70)
- [server/index.js](file://server/index.js#L1-L92)

## ç¯å¢ƒå˜é‡è¦†ç›–æœºåˆ¶

æœ¬é¡¹ç›®é‡‡ç”¨Viteçš„ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§æœºåˆ¶ï¼Œå®ç°çµæ´»çš„é…ç½®è¦†ç›–ï¼š

1. **é»˜è®¤é…ç½®**ï¼š`.env`æ–‡ä»¶æä¾›é»˜è®¤çš„ç¯å¢ƒå˜é‡å€¼
2. **æœ¬åœ°è¦†ç›–**ï¼š`.env.local`æ–‡ä»¶å¯ä»¥è¦†ç›–`.env`ä¸­çš„é…ç½®ï¼Œä¸”è¯¥æ–‡ä»¶é€šå¸¸è¢«.gitignoreå¿½ç•¥ï¼Œä¸ä¼šæäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
3. **ç¯å¢ƒç‰¹å®šé…ç½®**ï¼šæ”¯æŒ`.env.[mode]`å’Œ`.env.[mode].local`æ ¼å¼çš„æ–‡ä»¶ï¼Œç”¨äºä¸åŒç¯å¢ƒï¼ˆå¦‚developmentã€productionï¼‰çš„ç‰¹å®šé…ç½®

åœ¨ä»£ç ä¸­ï¼Œå‰ç«¯é€šè¿‡`import.meta.env.VITE_`å‰ç¼€è®¿é—®ç¯å¢ƒå˜é‡ï¼Œåç«¯é€šè¿‡`process.env`è®¿é—®ã€‚Viteä¼šè‡ªåŠ¨å°†`VITE_`å‰ç¼€çš„å˜é‡æš´éœ²ç»™å‰ç«¯ä»£ç ï¼Œè€Œå…¶ä»–å˜é‡åˆ™ä»…åœ¨æ„å»ºæ—¶å¯ç”¨ã€‚

```mermaid
flowchart TD
A[é»˜è®¤é…ç½® .env] --> B[æœ¬åœ°è¦†ç›– .env.local]
B --> C[ç¯å¢ƒç‰¹å®šé…ç½® .env.[mode]]
C --> D[æœ€ç»ˆç”Ÿæ•ˆé…ç½®]
D --> E[å‰ç«¯: import.meta.env]
D --> F[åç«¯: process.env]
```

**Diagram sources**
- [.env](file://.env#L1-L6)
- [.env.local](file://.env.local#L1-L15)
- [vite.config.js](file://vite.config.js#L1-L21)

**Section sources**
- [.env](file://.env#L1-L6)
- [.env.local](file://.env.local#L1-L15)

## Viteæ„å»ºé…ç½®

`vite.config.js`æ–‡ä»¶å®šä¹‰äº†Viteæ„å»ºå·¥å…·çš„æ ¸å¿ƒé…ç½®ï¼Œç‰¹åˆ«æ˜¯å¼€å‘æœåŠ¡å™¨çš„ä»£ç†è®¾ç½®ï¼š

```javascript
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

export default defineConfig({
  plugins: [vue()],
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:3001',
        changeOrigin: true,
      },
      '/influx': {
        target: 'http://localhost:8086',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/influx/, ''),
      },
    },
  },
})
```

### ä»£ç†é…ç½®è¯´æ˜

1. **APIä»£ç†**ï¼šå°†`/api`å‰ç¼€çš„è¯·æ±‚ä»£ç†åˆ°åç«¯æœåŠ¡å™¨`http://localhost:3001`
   - è§£å†³å¼€å‘ç¯å¢ƒä¸‹çš„è·¨åŸŸé—®é¢˜
   - å‰ç«¯ä»£ç å¯ä»¥ç›´æ¥ä½¿ç”¨`/api`è·¯å¾„ï¼Œæ— éœ€æŒ‡å®šå®Œæ•´URL

2. **InfluxDBä»£ç†**ï¼šå°†`/influx`å‰ç¼€çš„è¯·æ±‚ä»£ç†åˆ°InfluxDBæœåŠ¡`http://localhost:8086`
   - é€šè¿‡`rewrite`å‡½æ•°ç§»é™¤`/influx`å‰ç¼€ï¼Œå®ç°è·¯å¾„è½¬æ¢
   - å¢å¼ºå®‰å…¨æ€§ï¼Œé¿å…ç›´æ¥æš´éœ²InfluxDBçš„å®Œæ•´URL

### å¼€å‘æœåŠ¡å™¨é…ç½®

- **çƒ­é‡è½½**ï¼šViteæä¾›å¿«é€Ÿçš„æ¨¡å—çƒ­æ›¿æ¢ï¼Œæå‡å¼€å‘æ•ˆç‡
- **æŒ‰éœ€ç¼–è¯‘**ï¼šä»…ç¼–è¯‘è¯·æ±‚çš„æ¨¡å—ï¼Œå¯åŠ¨é€Ÿåº¦å¿«
- **TypeScriptæ”¯æŒ**ï¼šåŸç”Ÿæ”¯æŒTypeScriptï¼Œæ— éœ€é¢å¤–é…ç½®

```mermaid
flowchart LR
A[å‰ç«¯åº”ç”¨] --> B[Viteå¼€å‘æœåŠ¡å™¨]
B --> C[/api â†’ åç«¯æœåŠ¡]
B --> D[/influx â†’ InfluxDB]
C --> E[åç«¯API http://localhost:3001]
D --> F[InfluxDB http://localhost:8086]
```

**Diagram sources**
- [vite.config.js](file://vite.config.js#L1-L21)
- [src/services/postgres.js](file://src/services/postgres.js#L1-L245)

**Section sources**
- [vite.config.js](file://vite.config.js#L1-L21)

## é…ç½®æœ€ä½³å®è·µ

### 1. ç¯å¢ƒå˜é‡å‘½åè§„èŒƒ

- å‰ç«¯ç¯å¢ƒå˜é‡å¿…é¡»ä»¥`VITE_`ä¸ºå‰ç¼€ï¼Œæ‰èƒ½åœ¨å®¢æˆ·ç«¯ä»£ç ä¸­è®¿é—®
- åç«¯ç¯å¢ƒå˜é‡ä½¿ç”¨å¤§å†™å­—æ¯å’Œä¸‹åˆ’çº¿åˆ†éš”ï¼Œå¦‚`DB_HOST`ã€`SERVER_PORT`
- æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚å¯†ç ã€ä»¤ç‰Œï¼‰åº”é¿å…åœ¨ä»£ç ä¸­ç¡¬ç¼–ç 

### 2. é…ç½®æ–‡ä»¶ç»„ç»‡

```bash
# æ¨èçš„é…ç½®æ–‡ä»¶ç»“æ„
.env                # é»˜è®¤é…ç½®ï¼Œæäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
.env.local          # æœ¬åœ°è¦†ç›–é…ç½®ï¼Œæ·»åŠ åˆ°.gitignore
.env.development    # å¼€å‘ç¯å¢ƒç‰¹å®šé…ç½®
.env.production     # ç”Ÿäº§ç¯å¢ƒç‰¹å®šé…ç½®
```

### 3. æ•°æ®åº“è¿æ¥é…ç½®

PostgreSQLæ•°æ®åº“è¿æ¥é…ç½®åœ¨å‰åç«¯éƒ½æœ‰å®šä¹‰ï¼Œç¡®ä¿ä¸€è‡´æ€§ï¼š

```javascript
// server/db/index.js ä¸­çš„è¿æ¥æ± é…ç½®
const pool = new Pool({
    host: process.env.DB_HOST || 'localhost',
    port: parseInt(process.env.DB_PORT || '5432'),
    user: process.env.DB_USER || 'postgres',
    password: process.env.DB_PASSWORD || 'password',
    database: process.env.DB_NAME || 'tandem',
    max: 20,
    idleTimeoutMillis: 30000,
    connectionTimeoutMillis: 2000,
});
```

### 4. æœåŠ¡ç«¯å£é…ç½®

- å‰ç«¯å¼€å‘æœåŠ¡å™¨é»˜è®¤ä½¿ç”¨5173ç«¯å£ï¼ˆViteé»˜è®¤ï¼‰
- åç«¯APIæœåŠ¡å™¨ä½¿ç”¨`SERVER_PORT`ç¯å¢ƒå˜é‡é…ç½®ï¼Œå½“å‰è®¾ç½®ä¸º3001
- InfluxDBä½¿ç”¨é»˜è®¤çš„8086ç«¯å£

### 5. æ—¶åºæ•°æ®åº“é…ç½®

InfluxDBé…ç½®åœ¨å‰åç«¯ä¿æŒä¸€è‡´ï¼Œç¡®ä¿æ•°æ®å†™å…¥å’ŒæŸ¥è¯¢çš„ä¸€è‡´æ€§ï¼š

```javascript
// src/services/influx.ts ä¸­çš„é…ç½®ä½¿ç”¨
const url = import.meta.env.VITE_INFLUX_URL || '';
const token = import.meta.env.VITE_INFLUX_TOKEN || '';
const org = import.meta.env.VITE_INFLUX_ORG || '';
const bucket = import.meta.env.VITE_INFLUX_BUCKET || '';
```

**Section sources**
- [server/db/index.js](file://server/db/index.js#L1-L70)
- [src/services/influx.ts](file://src/services/influx.ts#L1-L136)
- [server/.env](file://server/.env#L1-L19)

## å¸¸è§é—®é¢˜æ’æŸ¥

### 1. æ•°æ®åº“è¿æ¥å¤±è´¥

**ç—‡çŠ¶**ï¼šåç«¯å¯åŠ¨æ—¶å‡ºç°"PostgreSQL è¿æ¥æ± é”™è¯¯"æˆ–"æŸ¥è¯¢é”™è¯¯"

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥`server/.env`æ–‡ä»¶ä¸­çš„æ•°æ®åº“è¿æ¥å‚æ•°
2. ç¡®è®¤PostgreSQLæœåŠ¡æ˜¯å¦æ­£åœ¨è¿è¡Œ
3. éªŒè¯æ•°æ®åº“ç”¨æˆ·åå’Œå¯†ç æ˜¯å¦æ­£ç¡®
4. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®ï¼Œç¡®ä¿5432ç«¯å£å¯è®¿é—®

```mermaid
flowchart TD
A[è¿æ¥å¤±è´¥] --> B{æ£€æŸ¥.envæ–‡ä»¶}
B --> C[å‚æ•°æ­£ç¡®?]
C --> |æ˜¯| D{PostgreSQLæœåŠ¡è¿è¡Œ?}
C --> |å¦| E[ä¿®æ­£å‚æ•°]
D --> |æ˜¯| F{ç½‘ç»œå¯è®¿é—®?}
D --> |å¦| G[å¯åŠ¨PostgreSQL]
F --> |æ˜¯| H[æ£€æŸ¥è®¤è¯]
F --> |å¦| I[æ£€æŸ¥é˜²ç«å¢™]
H --> J[éªŒè¯ç”¨æˆ·åå¯†ç ]
```

**Section sources**
- [server/db/index.js](file://server/db/index.js#L1-L70)
- [server/.env](file://server/.env#L1-L19)

### 2. APIè¯·æ±‚404é”™è¯¯

**ç—‡çŠ¶**ï¼šå‰ç«¯è°ƒç”¨APIè¿”å›404é”™è¯¯

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥Viteä»£ç†é…ç½®æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤åç«¯æœåŠ¡å™¨æ˜¯å¦å·²å¯åŠ¨
3. éªŒè¯APIç«¯ç‚¹è·¯å¾„æ˜¯å¦æ­£ç¡®
4. æ£€æŸ¥è·¨åŸŸè®¾ç½®

```javascript
// server/index.js ä¸­çš„APIè·¯ç”±é…ç½®
app.use('/api', apiRoutes);
app.use('/api/files', fileRoutes);
app.use('/api/documents', documentRoutes);
app.use('/api/views', viewsRoutes);
app.use('/api/v1/timeseries', timeseriesRoutes);
```

**Section sources**
- [vite.config.js](file://vite.config.js#L1-L21)
- [server/index.js](file://server/index.js#L1-L92)

### 3. InfluxDBæŸ¥è¯¢å¤±è´¥

**ç—‡çŠ¶**ï¼šæ—¶åºæ•°æ®æ— æ³•æ˜¾ç¤ºæˆ–å†™å…¥å¤±è´¥

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥`.env.local`ä¸­çš„InfluxDBè®¤è¯ä¿¡æ¯
2. éªŒè¯InfluxDBæœåŠ¡æ˜¯å¦è¿è¡Œ
3. ç¡®è®¤ç»„ç»‡(org)å’Œå­˜å‚¨æ¡¶(bucket)åç§°æ˜¯å¦æ­£ç¡®
4. æ£€æŸ¥ä»¤ç‰Œ(token)æ˜¯å¦æœ‰è¶³å¤Ÿçš„æƒé™

```javascript
// src/services/influx.ts ä¸­çš„é…ç½®éªŒè¯
export const isInfluxConfigured = () => !!(url && org && bucket && (token || (useBasic && basicUser && basicPass)));
```

**Section sources**
- [.env.local](file://.env.local#L1-L15)
- [src/services/influx.ts](file://src/services/influx.ts#L1-L136)

## å®‰å…¨å»ºè®®

### 1. æ•æ„Ÿä¿¡æ¯ä¿æŠ¤

- **é¿å…ç¡¬ç¼–ç **ï¼šç»ä¸å°†å¯†ç ã€ä»¤ç‰Œç­‰æ•æ„Ÿä¿¡æ¯ç›´æ¥å†™å…¥ä»£ç 
- **ä½¿ç”¨ç¯å¢ƒå˜é‡**ï¼šé€šè¿‡ç¯å¢ƒå˜é‡ç®¡ç†æ•æ„Ÿé…ç½®
- **.gitignoreç­–ç•¥**ï¼šå°†`.env.local`æ·»åŠ åˆ°`.gitignore`ï¼Œé˜²æ­¢æ„å¤–æäº¤

```bash
# .gitignore é…ç½®
.env.local
*.key
*.pem
```

### 2. è®¿é—®æ§åˆ¶

- **æœ€å°æƒé™åŸåˆ™**ï¼šæ•°æ®åº“ç”¨æˆ·åº”ä»…å…·æœ‰å¿…è¦çš„æƒé™
- **APIå¯†é’¥ç®¡ç†**ï¼šä½¿ç”¨`API_KEY_SECRET`ç­‰å¯†é’¥è¿›è¡Œæ¥å£å®‰å…¨éªŒè¯
- **ä»¤ç‰Œæœ‰æ•ˆæœŸ**ï¼šå®šæœŸè½®æ¢InfluxDBä»¤ç‰Œ

### 3. é…ç½®éªŒè¯

åœ¨åº”ç”¨å¯åŠ¨æ—¶éªŒè¯å…³é”®é…ç½®ï¼š

```javascript
// server/db/index.js ä¸­çš„è¿æ¥äº‹ä»¶
pool.on('connect', () => {
    console.log('ğŸ“¦ PostgreSQL è¿æ¥å·²å»ºç«‹');
});

pool.on('error', (err) => {
    console.error('âŒ PostgreSQL è¿æ¥æ± é”™è¯¯:', err);
});
```

### 4. ç”Ÿäº§ç¯å¢ƒé…ç½®

ç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨ç‹¬ç«‹çš„é…ç½®æ–‡ä»¶ï¼š

```env
# .env.production ç¤ºä¾‹
VITE_INFLUX_URL=https://influx.example.com
VITE_INFLUX_ORG=production
DB_HOST=prod-db.example.com
SERVER_PORT=80
```

**Section sources**
- [.env.local](file://.env.local#L1-L15)
- [server/.env](file://server/.env#L1-L19)