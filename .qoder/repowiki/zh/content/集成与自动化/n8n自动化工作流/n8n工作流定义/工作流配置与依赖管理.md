# 工作流配置与依赖管理

<cite>
**本文档引用的文件**  
- [docker/.env.production.example](file://docker/.env.production.example)
- [n8n-workflows/README.md](file://n8n-workflows/README.md)
- [server/services/n8n-service.js](file://server/services/n8n-service.js)
- [server/config/openwebui-config.js](file://server/config/openwebui-config.js)
- [server/.env](file://server/.env)
- [n8n-workflows/temperature-alert-workflow.json](file://n8n-workflows/temperature-alert-workflow.json)
- [docker/docker-compose.prod.yml](file://docker/docker-compose.prod.yml)
</cite>

## 目录

1. [引言](#引言)  
2. [核心环境变量配置](#核心环境变量配置)  
3. [n8n 凭证安全管理](#n8n-凭证安全管理)  
4. [工作流初始化步骤](#工作流初始化步骤)  
5. [常见配置错误与排查](#常见配置错误与排查)  
6. [总结](#总结)

## 引言

本项目通过 n8n 实现自动化 AI 分析工作流，用于处理温度报警等事件。为确保工作流正常运行，必须正确配置一系列外部依赖项，包括环境变量、API 密钥、Webhook 地址等。本文档系统化说明这些配置项的设置方法、安全实践及初始化流程，并提供常见问题的排查清单。

**Section sources**  
- [n8n-workflows/README.md](file://n8n-workflows/README.md)

## 核心环境变量配置

### 必需的环境变量

工作流依赖多个环境变量，主要分为三类：基础服务配置、AI 服务集成和通知系统配置。

#### 基础服务配置

| 变量名 | 说明 | 示例值 | 来源文件 |
|--------|------|--------|----------|
| `N8N_WEBHOOK_URL` | 用于生成回调地址，触发 n8n 工作流 | `https://your-domain.com/webhook/` | [docker/.env.production.example](file://docker/.env.production.example#L43) |
| `DB_PASSWORD` | PostgreSQL 数据库密码，用于持久化工作流数据 | `secure_password_123` | [docker/.env.production.example](file://docker/.env.production.example#L22) |
| `TZ` | 时区设置，影响日志和调度时间 | `Asia/Shanghai` | [docker/.env.production.example](file://docker/.env.production.example#L10) |

#### AI 服务集成

| 变量名 | 说明 | 示例值 | 来源文件 |
|--------|------|--------|----------|
| `GEMINI_API_KEY` | Google Gemini 服务认证密钥，驱动 Open WebUI 的 AI 能力 | `AIzaSy...` | [docker/.env.production.example](file://docker/.env.production.example#L38) |
| `OPENWEBUI_URL` | Open WebUI 服务地址，用于知识库查询和 RAG 检索 | `http://host.docker.internal:3080` | [n8n-workflows/README.md](file://n8n-workflows/README.md#L49) |
| `API_BASE_URL` | 后端 API 地址，用于上下文数据查询 | `http://host.docker.internal:3001` | [n8n-workflows/README.md](file://n8n-workflows/README.md#L48) |

#### 通知系统配置

| 变量名 | 说明 | 示例值 | 来源文件 |
|--------|------|--------|----------|
| `SMTP_HOST` | 邮件服务器地址，用于发送告警通知 | `smtp.gmail.com` | [docker/.env.production.example](file://docker/.env.production.example#L67) |
| `SMTP_USER` | 邮件账户用户名 | `alert@company.com` | [docker/.env.production.example](file://docker/.env.production.example#L69) |
| `SMTP_PASSWORD` | 邮件账户应用密码 | `app_password_123` | [docker/.env.production.example](file://docker/.env.production.example#L70) |

### 配置文件示例

在 `docker/.env.production.example` 中定义了生产环境模板，需复制为 `.env` 并填写实际值：

```env
# 域名（用于 SSL 和 Webhook）
DOMAIN=your-domain.com

# PostgreSQL 配置
DB_PASSWORD=your_secure_password_here

# Google Gemini API Key
GEMINI_API_KEY=your_gemini_api_key_here

# n8n 认证配置
N8N_AUTH_PASSWORD=your_n8n_password
```

**Section sources**  
- [docker/.env.production.example](file://docker/.env.production.example)

## n8n 凭证安全管理

为避免在工作流中硬编码敏感信息（如 API 密钥），n8n 提供了 **Credentials** 功能来安全存储和管理凭证。

### 配置 Open WebUI API 凭据

1. 登录 n8n 控制台（`http://localhost:5678`）
2. 点击左侧菜单的 **Credentials**
3. 点击 **Add Credential**
4. 选择 **Header Auth** 类型
5. 填写以下信息：
   - **名称**：`Open WebUI API Key`
   - **Header Name**：`Authorization`
   - **Header Value**：`Bearer sk-xxxxxxxx`（您的 Open WebUI API Key）

该凭证可在 HTTP 请求节点中引用，确保密钥不会暴露在工作流逻辑中。

### 工作流中的凭证使用

在 `temperature-alert-workflow.json` 中，`调用 Open WebUI RAG` 节点通过以下方式使用凭证：

```json
"credentials": {
  "httpHeaderAuth": {
    "id": "openwebui-api-key",
    "name": "Open WebUI API Key"
  }
}
```

此机制实现了凭证与工作流逻辑的解耦，提升安全性。

**Section sources**  
- [n8n-workflows/README.md](file://n8n-workflows/README.md#L52-L60)  
- [n8n-workflows/temperature-alert-workflow.json](file://n8n-workflows/temperature-alert-workflow.json#L97-L101)

## 工作流初始化步骤

### 1. 导入工作流

1. 打开 n8n 控制台：`http://localhost:5678`
2. 点击左侧菜单的 **Workflows**
3. 点击右上角 **Import from File**
4. 选择 `n8n-workflows/temperature-alert-workflow.json`

### 2. 绑定凭证

导入后，需为 `调用 Open WebUI RAG` 节点绑定之前创建的 `Open WebUI API Key` 凭证。

### 3. 注册 Webhook URL 到 TwinSight 系统

确保后端服务的 `N8N_WEBHOOK_URL` 与 n8n 配置一致。在 `server/.env` 中设置：

```env
USE_N8N_WORKFLOW=true
N8N_WEBHOOK_URL=http://localhost:5678
N8N_TEMPERATURE_ALERT_WEBHOOK=/webhook/temperature-alert
```

此配置使后端在检测到温度报警时，自动调用 n8n 的 Webhook。

### 4. 构造测试触发器

使用以下 `curl` 命令测试工作流是否正常运行：

```bash
curl -X POST http://localhost:5678/webhook/temperature-alert \
  -H "Content-Type: application/json" \
  -d '{
    "roomCode": "BF02US01",
    "roomName": "配电间",
    "temperature": 28.5,
    "threshold": 23,
    "alertType": "high",
    "fileId": 1
  }'
```

预期响应包含 AI 生成的分析文本和引用来源。

**Section sources**  
- [n8n-workflows/README.md](file://n8n-workflows/README.md#L34-L145)  
- [server/.env](file://server/.env#L19-L22)

## 常见配置错误与排查

### 权限拒绝（401/403）

| 可能原因 | 解决方案 |
|---------|----------|
| n8n 基础认证未配置或密码错误 | 检查 `N8N_BASIC_AUTH_USER` 和 `N8N_BASIC_AUTH_PASSWORD` 是否正确 |
| Open WebUI API Key 无效 | 在 n8n Credentials 中重新输入有效的 API Key |
| 后端未启用 n8n 模式 | 确保 `USE_N8N_WORKFLOW=true` 已设置 |

### 超时失败（504/Timeout）

| 可能原因 | 解决方案 |
|---------|----------|
| Open WebUI 响应缓慢 | 检查 `openwebui-config.js` 中的 `rag.topK` 和 `allowWebSearch` 设置 |
| 网络不通（Docker 内部） | 使用 `host.docker.internal` 或 Docker 网络别名（如 `open-webui`）确保服务可达 |
| Webhook 路径错误 | 核对 `N8N_WEBHOOK_URL` 和 `N8N_TEMPERATURE_ALERT_WEBHOOK` 是否匹配 |

### 数据库连接失败

| 可能原因 | 解决方案 |
|---------|----------|
| `DB_PASSWORD` 未设置 | 在 `.env` 文件中填写正确的数据库密码 |
| PostgreSQL 服务未启动 | 检查 `docker-compose.prod.yml` 中 `postgres` 服务状态 |
| 网络隔离 | 确保所有服务在同一 Docker 网络（`tandem-network`）中 |

### 其他常见问题

- **Gemini API Key 无效**：前往 [Google AI Studio](https://makersuite.google.com/app/apikey) 重新生成。
- **SSL 证书错误**：将证书文件（`fullchain.pem` 和 `privkey.pem`）放置在 `./ssl/` 目录。
- **工作流节点缺失**：确保 `docker-compose.prod.yml` 中已包含 `n8n` 服务。

**Section sources**  
- [docker/.env.production.example](file://docker/.env.production.example#L85-L89)  
- [server/middleware/error-handler.js](file://server/middleware/error-handler.js)  
- [docker/docker-compose.prod.yml](file://docker/docker-compose.prod.yml)

## 总结

为确保 n8n 工作流正常运行，必须系统化配置外部依赖项。关键步骤包括：在 `.env.production.example` 中设置 `N8N_WEBHOOK_URL`、`GEMINI_API_KEY` 等环境变量；通过 n8n UI 的 Credentials 功能安全存储 API 密钥；导入工作流后完成凭证绑定和 Webhook 注册；并通过构造测试请求验证流程。对于常见错误，应优先检查权限、网络连通性和配置一致性。