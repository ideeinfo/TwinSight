# 快速入门

<cite>
**本文档中引用的文件**  
- [README.md](file://README.md)
- [package.json](file://package.json)
- [server/package.json](file://server/package.json)
- [.env](file://.env)
- [server/.env](file://server/.env)
- [docker-compose.yml](file://docker-compose.yml)
- [docker/docker-compose.prod.yml](file://docker/docker-compose.prod.yml)
- [vite.config.js](file://vite.config.js)
- [server/index.js](file://server/index.js)
- [server/config/index.js](file://server/config/index.js)
- [server/db/schema.sql](file://server/db/schema.sql)
- [Dockerfile](file://Dockerfile)
- [server/scripts/init-db.js](file://server/scripts/init-db.js)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [环境准备](#环境准备)
4. [克隆仓库](#克隆仓库)
5. [配置环境变量](#配置环境变量)
6. [安装依赖](#安装依赖)
7. [启动开发环境](#启动开发环境)
8. [Docker快速部署](#docker快速部署)
9. [首次运行验证](#首次运行验证)
10. [常见问题与解决方案](#常见问题与解决方案)
11. [结论](#结论)

## 简介

本指南旨在为新开发者提供一份详尽的入门教程，帮助您快速搭建TwinSight项目的开发环境。我们将逐步介绍如何克隆代码仓库、配置必要的环境变量、安装Node.js依赖，并启动前端Vite和后端Express服务。同时，我们还提供了使用Docker进行快速部署的指令，解释不同compose文件的用途，并列举了首次运行时的验证步骤和常见初始化问题的解决方案。本指南力求对零基础开发者友好，配有清晰的命令行示例。

## 项目结构

TwinSight项目采用前后端分离的架构，前端基于Vue 3 + Vite构建，后端使用Express框架。项目主要包含以下核心目录：

- `src/`: 前端源代码，使用Vue 3和TypeScript开发。
- `server/`: 后端API服务，基于Express框架，提供数据接口。
- `docker/`: Docker相关配置文件，包括生产环境的compose文件和Nginx配置。
- `n8n-workflows/` 和 `nodered/`: AI和IoT工作流配置。
- `scripts/`: 项目脚本文件。

**Section sources**
- [README.md](file://README.md)
- [package.json](file://package.json)
- [server/package.json](file://server/package.json)

## 环境准备

在开始之前，请确保您的开发机器上已安装以下软件：

- **Git**: 用于克隆代码仓库。
- **Node.js (v18或更高版本)**: 项目前后端均基于Node.js运行。
- **npm**: Node.js的包管理器，用于安装项目依赖。
- **Docker (可选)**: 用于一键部署所有服务（数据库、AI、IoT等）。

您可以通过以下命令检查Node.js和npm的版本：
```bash
node --version
npm --version
```

## 克隆仓库

打开您的终端（命令行工具），执行以下命令来克隆TwinSight项目仓库：

```bash
git clone https://github.com/your-organization/TwinSight.git
cd TwinSight
```

这将把项目代码下载到本地的`TwinSight`目录中，并进入该目录。

## 配置环境变量

项目使用`.env`文件来管理环境变量。您需要为前端和后端分别配置。

### 1. 前端环境变量

项目根目录下的`.env`文件用于配置前端应用。一个典型的配置如下：

```env
# API 服务器配置
VITE_API_URL=http://localhost:3001

# Open WebUI API密钥
OPENWEBUI_API_KEY=your-openwebui-api-key
```

- `VITE_API_URL`: 指向前端需要调用的后端API地址。在本地开发时，通常指向`http://localhost:3001`。
- `OPENWEBUI_API_KEY`: 用于与Open WebUI AI服务通信的API密钥。

**Section sources**
- [.env](file://.env)

### 2. 后端环境变量

后端服务的配置文件位于`server/.env`。您需要根据您的环境修改以下关键配置：

```env
# PostgreSQL 数据库配置
DB_HOST=localhost
DB_PORT=5432
DB_NAME=twinsight
DB_USER=postgres
DB_PASSWORD=password

# 服务器配置
SERVER_PORT=3001

# n8n 工作流配置
USE_N8N_WORKFLOW=true
N8N_WEBHOOK_URL=http://localhost:5678
```

- `DB_*`: 数据库连接信息，确保与`docker-compose.yml`中PostgreSQL服务的配置一致。
- `SERVER_PORT`: 后端服务监听的端口。
- `USE_N8N_WORKFLOW`: 控制是否启用n8n工作流模式。

**Section sources**
- [server/.env](file://server/.env)

## 安装依赖

项目包含两个独立的`package.json`文件，分别位于项目根目录（前端）和`server/`目录（后端）。您需要分别安装它们的依赖。

1.  **安装前端依赖**:
    ```bash
    npm install
    ```

2.  **安装后端依赖**:
    ```bash
    cd server
    npm install
    cd ..
    ```

此步骤会根据`package.json`文件下载所有必需的Node.js包。

**Section sources**
- [package.json](file://package.json)
- [server/package.json](file://server/package.json)

## 启动开发环境

完成依赖安装后，您可以分别启动前端和后端服务。

### 1. 启动后端服务 (Express)

在`server/`目录下，使用以下命令启动后端API服务：

```bash
cd server
npm run dev
```

您应该会在终端看到类似以下的输出，表明服务已成功启动：
```
╔════════════════════════════════════════════════╗
║     Twinsight API Server                       ║
╠════════════════════════════════════════════════╣
║  🚀 服务已启动                                 ║
║  📍 绑定地址: 0.0.0.0:3001                      ║
║  📦 数据库: PostgreSQL                         ║
╚════════════════════════════════════════════════╝
```

### 2. 启动前端服务 (Vite)

在项目根目录下，启动前端开发服务器：

```bash
npm run dev
```

Vite会启动一个开发服务器，并在终端输出访问地址，通常是`http://localhost:5173`。

### 3. 初始化数据库 (可选)

如果这是首次运行，您可能需要初始化数据库表结构。在`server/`目录下执行：
```bash
npm run db:init
```
此命令会执行`server/db/schema.sql`中的SQL语句，创建所有必需的数据库表。

**Section sources**
- [server/index.js](file://server/index.js)
- [server/config/index.js](file://server/config/index.js)
- [server/scripts/init-db.js](file://server/scripts/init-db.js)
- [server/db/schema.sql](file://server/db/schema.sql)

## Docker快速部署

对于希望快速体验完整功能的用户，项目提供了Docker支持。

### 1. 使用 `docker-compose.yml` (开发/演示环境)

此文件定义了完整的开发环境，包括PostgreSQL、InfluxDB、n8n、Node-RED、Grafana和Open WebUI等服务。

启动所有服务：
```bash
docker-compose up -d
```

停止所有服务：
```bash
docker-compose down
```

### 2. 使用 `docker/docker-compose.prod.yml` (生产环境)

此文件用于生产部署，包含Nginx反向代理，将所有服务统一暴露在80/443端口。

启动生产环境服务：
```bash
docker-compose -f docker/docker-compose.prod.yml up -d
```

**关键区别**:
- `docker-compose.yml`: 服务直接暴露端口（如5432, 8086, 3001），适合本地开发和调试。
- `docker-compose.prod.yml`: 使用Nginx作为反向代理，通过路径前缀（如`/api`, `/n8n`）路由到不同服务，适合生产环境。

**Section sources**
- [docker-compose.yml](file://docker-compose.yml)
- [docker/docker-compose.prod.yml](file://docker/docker-compose.prod.yml)

## 首次运行验证

服务启动后，请按以下步骤验证一切正常：

1.  **检查后端API**:
    在浏览器中访问 `http://localhost:3001/api/health`。您应该收到一个JSON响应：
    ```json
    {"status":"ok","timestamp":"2024-01-01T00:00:00.000Z","env":"development"}
    ```

2.  **访问前端应用**:
    打开浏览器，访问 `http://localhost:5173`。您应该能看到TwinSight的前端界面。

3.  **检查Docker服务状态**:
    运行 `docker-compose ps` 查看所有容器的状态，确保它们都处于`Up`状态。

## 常见问题与解决方案

### 1. 端口冲突

**问题**: 启动服务时提示`EADDRINUSE`（地址已在使用）。
**解决方案**: 检查`3001`（后端）、`5173`（前端）、`5432`（PostgreSQL）等端口是否被其他程序占用。您可以使用`lsof -i :3001`（macOS/Linux）或`netstat -ano | findstr :3001`（Windows）查找占用进程并终止，或修改`.env`文件中的端口号。

### 2. 数据库连接失败

**问题**: 后端启动时提示无法连接到PostgreSQL。
**解决方案**:
- 确保`docker-compose up -d`已成功运行，且`twinsight-postgres`容器状态为`Up`。
- 检查`server/.env`文件中的`DB_HOST`, `DB_PORT`, `DB_USER`, `DB_PASSWORD`是否与`docker-compose.yml`中的配置完全一致。

### 3. 依赖安装失败

**问题**: `npm install`过程中出现网络错误或包下载失败。
**解决方案**: 尝试更换npm镜像源，例如使用淘宝镜像：
```bash
npm config set registry https://registry.npmmirror.com
```

## 结论

恭喜！您已成功完成TwinSight项目的环境搭建。现在，您可以开始探索代码、开发新功能或进行调试。本指南涵盖了从零开始的所有必要步骤。如果遇到任何未在此列出的问题，建议查阅项目根目录下的`README.md`文件或检查相关服务的日志以获取更详细的错误信息。