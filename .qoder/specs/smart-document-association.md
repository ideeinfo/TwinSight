# 智能文档关联功能实现计划

## 需求概述

实现文件名与房间(space)、资产(asset)、资产规格(asset_spec)的编码和名称自动匹配功能。上传文档后弹出确认对话框，用户可查看/编辑自动匹配的关联关系，最终确认保存。

---

## 一、匹配算法设计

### 多阶段匹配策略

| 阶段 | 匹配方式 | 置信度 | 说明 |
|------|---------|--------|------|
| 1 | 精确匹配 | 95-100% | 文件名完全匹配编码 |
| 2 | 模式匹配 | 70-90% | 正则提取编码模式 |
| 3 | 关键词匹配 | 50-70% | 名称/类别模糊搜索 |

### 编码模式正则
```javascript
// 资产编码：字母+数字
/\b([A-Z]{2,6}[-_]?\d{1,4})\b/gi  // AHU-01, PUMP001

// 空间编码：楼层-区域-房间
/\b([B]?\d+[-_]?\d{2}[-_]?\d{3})\b/gi  // B1-01-001, 3-02-012

// 规格编码：品牌型号
/\b([A-Z]{2,}\s?[0-9A-Z\-]+)\b/g  // DAIKIN VRV-Q
```

### 置信度计算
```
置信度 = 基础得分 × 位置权重 × 长度相似度

位置权重: 文件名首位=1.0, 中间=0.9, 末尾=0.8
长度相似度: 编码长度/文件名长度
```

---

## 二、API 设计

### 2.1 匹配接口
**POST `/api/v2/documents/match-associations`**

```javascript
// 请求
{
  "fileNames": ["AHU-01_维护记录.pdf", "3F-会议室_全景图.jpg"],
  "options": { "minConfidence": 50, "maxResults": 20 }
}

// 响应
{
  "success": true,
  "data": [
    {
      "fileName": "AHU-01_维护记录.pdf",
      "matches": [
        { "type": "asset", "code": "AHU-01", "name": "空调机组-1", "confidence": 95 },
        { "type": "spec", "code": "AHU-100T", "name": "Carrier空调", "confidence": 72 }
      ]
    }
  ]
}
```

### 2.2 批量关联接口
**POST `/api/v2/documents/batch-associations`**

```javascript
// 请求
{
  "associations": [
    { "documentId": 123, "items": [
      { "type": "asset", "code": "AHU-01" },
      { "type": "space", "code": "3-02-001" }
    ]}
  ]
}
```

### 2.3 对象搜索接口
**GET `/api/v2/objects/search?q=会议&types=asset,space,spec`**

```javascript
// 响应
{
  "success": true,
  "data": [
    { "type": "space", "code": "3-02-001", "name": "3F-会议室A" },
    { "type": "asset", "code": "AC-001", "name": "会议室空调" }
  ]
}
```

---

## 三、前端对话框

### 布局结构
```
┌─────────────────────────────────────────────────────────────┐
│  智能关联确认                                          [×]  │
├──────────────────────┬──────────────────────────────────────┤
│  文件列表 (3)        │  关联对象                            │
│ ─────────────────── │ ──────────────────────────────────── │
│ ● AHU-01_维护.pdf   │  🔧 [资产] AHU-01 空调机组   95% [×] │
│   3F-会议室.jpg     │  📋 [规格] AHU-100T Carrier  72% [×] │
│   设计说明.docx     │  ────────────────────────────────── │
│                     │  + 手动添加关联                       │
│                     │  [类型▼] [搜索对象...]        [添加] │
├──────────────────────┴──────────────────────────────────────┤
│  ⚠️ 低置信度项目已标记黄色，请确认                          │
│                              [跳过关联]  [确认并上传]       │
└─────────────────────────────────────────────────────────────┘
```

### 置信度颜色
- **≥80%** 绿色 `#52c41a`
- **60-79%** 蓝色 `#1890ff`  
- **50-59%** 黄色 `#faad14`
- **<50%** 灰色 `#8c8c8c`

### 交互流程
1. 用户选择文件点击"上传"
2. 前端调用 `/match-associations` 获取匹配结果
3. 弹出对话框显示匹配（如无匹配直接上传）
4. 用户可删除/添加关联
5. 点击"确认并上传"：先上传文件，再批量创建关联

---

## 四、关键文件清单

| 文件 | 操作 | 说明 |
|------|------|------|
| `server/services/document-matching-service.js` | **新建** | 匹配算法核心服务 |
| `server/routes/v2/documents.js` | 修改 | 添加 match/batch-associations API |
| `server/routes/v2/objects.js` | **新建** | 对象搜索 API |
| `src/components/DocumentAssociationDialog.vue` | **新建** | 关联确认对话框 |
| `src/components/DocumentManager.vue` | 修改 | 集成关联确认流程 |
| `src/i18n/index.js` | 修改 | 添加国际化文本 |

---

## 五、实施步骤

### Phase 1: 后端服务 (优先)
1. 创建 `document-matching-service.js`
   - 实现文件名预处理和编码提取
   - 实现精确匹配和模式匹配
   - 实现置信度计算
2. 添加 `/match-associations` API
3. 添加 `/batch-associations` API
4. 添加 `/objects/search` API

### Phase 2: 前端组件
1. 创建 `DocumentAssociationDialog.vue`
   - 左右分栏布局
   - 文件列表（点击切换）
   - 匹配结果展示（置信度着色）
   - 删除关联按钮
   - 手动添加关联（搜索选择）
2. 修改 `DocumentManager.vue` 上传流程
3. 添加国际化文本

---

## 六、验证测试

| 测试场景 | 预期结果 |
|---------|---------|
| 上传 `BF02US02_全景.jpg` | 匹配空间 BF02US02，置信度 95%+ |
| 上传 `AHU-01_手册.pdf` | 匹配资产 AHU-01，置信度 95%+ |
| 上传 `会议室照片.jpg` | 模糊匹配含"会议室"的空间，置信度 60-80% |
| 上传 `123.tmp` | 无匹配，显示空状态 |
| 手动添加关联 | 搜索对象，添加成功 |
| 确认上传 | 文件上传 + 关联创建成功 |
