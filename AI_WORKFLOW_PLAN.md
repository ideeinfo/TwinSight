
---

# 模块开发任务书：AI分析工作流

## 1. 任务目标
构建一个基于n8n、Open WebUI和本系统的自动化运维建议流程。实现从资产文档到RAG（检索增强生成）知识库的自动同步，以及基于IoT触发的智能辅助分析。

## 2. 技术栈与全局约束
*   **编码规范**：所有代码严格使用 `UTF-8` 编码。
*   **数据库**：所有新表记录必须包含 `UUID` 字段。
*   **多语言**：功能编写完成后，立即更新多语言配置文件。
*   **解耦要求**：严格遵循重构后的框架，确保功能模块独立。
*   **核心组件**：n8n (Workflow), Open WebUI (RAG Engine), 后台API。

---

## 3. 核心子任务分解

### 子任务 A：Open WebUI 知识库自动化管理
**目标**：实现系统资产文档与 Open WebUI 知识库的同步。
1.  **知识库自动创建**：
    *   开发监听器：当系统内上传新的“模型文件”时，调用 Open WebUI API 在其工作区同步建立同名的知识库（Collection）。
2.  **文档自动同步**：
    *   识别范围：包括模型文件、资产信息、资产规格、空间相关文档。
    *   格式校验：仅同步 Open WebUI 支持的 RAG 格式（如 .docx, .xlsx, .pptx, .pdf, .md, .txt 等）。
    *   自动上传：通过 API 将上述文档自动推送至对应的 Open WebUI 知识库。

### 子任务 B：n8n 运维分析工作流开发
**目标**：编写 n8n 工作流逻辑，处理从报警到建议生成的闭环。
1.  **Webhook 触发端点**：
    *   接收房间温度等 IoT 设备触发的阈值报警数据。
2.  **上下文检索**：
    *   根据报警所属房间，从系统数据库中检索：
        *   关联的设备类型。
        *   对应的运维手册文档名称及关联的知识库 ID。
3.  **AI 交互逻辑**：
    *   调用 Open WebUI API，参数要求：
        *   `knowledge_base_id`: 对应资产的知识库。
        *   `search_mode`: 优先基于知识库检索。
        *   `allow_web_search`: 如果知识库无匹配项，允许联网搜索。
        *   `prompt`: 结合报警数据与资产上下文请求运维建议。
4.  **结果格式化**：
    *   解析 AI 返回的回复及引用的来源文档。
    *   **关键逻辑**：为每个引用的来源文档名称生成可点击的系统预览 URL,如果是系统内部文档，需要生成系统内的URL。

### 子任务 C：前端 AI 分析面板
**目标**：在系统 UI 中展示分析结果。
1.  **UI 表现层**：
    *   遵循统一 UI 风格和现有皮肤主题。
    *   开发“AI 分析面板”，用于弹出显示运维建议。
2.  **交互功能**：
    *   点击建议中的引用来源 URL，支持直接打开相关文档或网页。

---

## 4. 接口 (API) 开发需求
1.  **GET /api/v1/assets/docs**：根据资产/空间 ID 获取关联文档详情（用于 n8n 匹配）。
2.  **POST /api/v1/ai/sync-kb**：触发手动同步文档到 Open WebUI 的接口。
3.  **提供完整的后台 API Swagger 文档。**

---

## 5. 测试与验证要求
1.  **单元测试**：针对文档同步逻辑、URL 生成逻辑编写 Unit Test。
2.  **集成测试**：
    *   模拟 IoT 报警，验证 n8n 是否能准确调用 Open WebUI。
    *   验证 RAG 回复中是否包含正确的来源文档名称。
    *   验证点击来源链接是否能正确跳转。

## 6. 典型场景逻辑流（供 Agent 参考）
`IoT报警 (温度过高)` -> `n8n 接收 Webhook` -> `查询 DB (获取该房间空调说明书及知识库ID)` -> `请求 Open WebUI (带 RAG 检索)` -> `生成建议 (引用说明书第5页内容)` -> `n8n 处理 URL` -> `系统前端弹出面板显示建议及链接`。

---

**Agent 执行提示**：在开始编写代码前，请先检查现有框架中 `Open WebUI API` 的连接器配置，并确保数据库迁移脚本中已包含 `UUID`。