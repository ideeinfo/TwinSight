# Bug Fixes Summary

This document consolidates bug fix notes and walkthroughs from the `todo/` directory, serving as a historical reference for resolved issues.

## 2026-02-10: Citation System & AI Alert Fixes
**Source**: `todo/修复照片引用_20260210`

### Issues
- Citation markers `[x]` in AI responses were not clickable or pointed to wrong documents.
- "References" section was sometimes duplicated.
- Images with certain extensions (JPG/PNG) were excluded from context retrieval.
- "Reference Documents" lacked indices when sources were not explicitly cited.

### Fixes
- **Smart Reference Parsing**: Implemented robust parsing in `AIChatPanel` to map citation numbers to actual document files from the "References" section.
- **Rich Markdown**: Enhanced `markdown-it` configuration to support headers, lists, and paragraphs.
- **Click Handling**: Emits file metadata on click for preview.
- **Source List Refactor**: Created `AISourceList.vue` for cleaner display.
- **Backend enhancements**: RAG service now includes asset codes in search patterns and removed restrictive image type filters.

## 2026-02-04: RDS Hierarchy & Tree Sync Fixes
**Source**: `todo/FixAspectTreeSelectionSync_20260204`, `todo/RDSHierarchyFix_20260204`, `todo/fix_duplicate_aspects_20260204`

### Issue 1: Tree Selection Sync
- **Problem**: Selecting a node in one system tree (e.g., Fire) would auto-select the same device in another system tree (e.g., Lighting) because they shared the same backend ID.
- **Fix**: Generated unique `uitreeId` in frontend (`AspectTreePanel.vue`) to decouple selection state while maintaining logical link to the same physical device.

### Issue 2: Incorrect RDS Logic (Dot Syntax)
- **Problem**: IEC 81346 dot syntax was misinterpreted. `A.` should be the parent of `A.B`, not a sibling.
- **Fix**: Updated `logic-engine/services/iec_parser.py` to correctly calculate parent code and hierarchy level for dot-ending codes.

### Issue 3: Duplicate Aspects (Multi-Parent)
- **Problem**: When multiple objects shared the same RDS code (e.g., two cabinets both named `===DY1.`), the tree builder only picked one parent, hiding children of the others.
- **Fix**: Updated `server/routes/rds.js` to support one-to-many mapping (`Code -> [Node1, Node2]`). Child nodes are now cloned and mounted to *all* matching parents.

## 2026-01-29: Frontend URL Refactor
**Source**: `todo/Frontend_URL_Refactor_20260129`

### Issues
- Hardcoded `http://localhost:3000` specificially in `AppViewer.vue` broke functionality when accessed via LAN IP or domain.

### Fixes
- **Dynamic Base URL**: Replaced hardcoded origin with `window.location.origin` for relative paths.
- **Configurable API URL**: Used `import.meta.env.VITE_API_BASE_URL` or fallback to relative `/` for API calls.

## 2026-01-25: n8n Configuration & Document Discovery
**Source**: `todo/fix_n8n_config_20260125`

### Issues
- AI analysis failed due to missing n8n integration details.
- Knowledge Base sync created duplicate/invalid records.
- Synced files appeared as system paths instead of original filenames.

### Fixes
- **Config Loading**: Enforced `.env.local` loading with override in backend.
- **Text Scanning**: Backend now scans analysis text for document names to auto-add sources.
- **Cleanup Logic**: `files.js` deletion logic updated to remove `kb_documents` records by both internal ID and external UUID before rebuilding.
- **Filename Persistence**: Passed original `file_name` to Open WebUI during upload.

## 2026-01-12: Delete Functionality Fixes
**Source**: `todo/删除功能修复_20260112`

### Issues
- Delete confirmation dialog buttons were in English.
- Deleting non-empty folders failed.

### Fixes
- **i18n**: Added localization to `ElMessageBox.confirm` buttons.
- **Recursive Delete**: Updated backend `DELETE /folders/:id` to recursively remove all child files and subfolders.

## 2026-01-27: Code Review Fixes (Partial)
**Source**: `todo/code_review_20260127.md`

### Issues
- `extractExif` read entire files into memory.
- `ai-analysis.js` route handler was too large and complex.

### Status
- **Critical Fix**: `extractExif` issue flagged as critical. (Check if implemented).
- **Refactor**: Recommendation to move logic to `ai-service.js`.

---
*Generated by Agent on 2026-02-12*
